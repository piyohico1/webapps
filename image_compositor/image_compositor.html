<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç°¡å˜ç”»åƒåˆæˆãƒ„ãƒ¼ãƒ«</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            margin: 0;
            font-size: 2.5em;
            font-weight: 300;
        }

        .content {
            padding: 30px;
        }

        .upload-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .upload-box {
            border: 3px dashed #ddd;
            border-radius: 15px;
            padding: 40px 20px;
            text-align: center;
            background: #fafafa;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            height: 200px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .upload-box:hover {
            border-color: #4facfe;
            background: #f0f8ff;
            transform: translateY(-5px);
        }

        .upload-box.dragover {
            border-color: #4facfe;
            background: #e6f3ff;
        }

        .upload-box h3 {
            margin-top: 0;
            color: #666;
            font-size: 1.3em;
        }

        .upload-box input[type="file"] {
            display: none;
        }

        .upload-icon {
            font-size: 3em;
            margin-bottom: 15px;
            color: #4facfe;
        }

        .preview-image {
            max-width: 100%;
            max-height: 80px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            margin-top: 10px;
        }

        .clear-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #ff4757;
            color: white;
            border: none;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 18px;
            display: none;
        }

        .workspace {
            display: grid;
            grid-template-columns: 1fr 300px;
            gap: 30px;
            margin-bottom: 30px;
        }

        .canvas-container {
            position: relative;
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            text-align: center;
        }

        .main-canvas {
            width: 100%;
            height: auto;
            max-height: 900px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            cursor: grab;
            object-fit: contain;
        }

        .main-canvas.eraser-mode {
            cursor: crosshair;
        }

        .main-canvas:active {
            cursor: grabbing;
        }

        .controls {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 15px;
            height: fit-content;
        }

        .controls h3 {
            margin-top: 0;
            color: #555;
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
        }

        .control-section {
            background: white;
            border: 2px solid #eee;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .control-section.collapsed {
            padding: 0;
        }

        .control-section h3 {
            margin-top: 0;
            margin-bottom: 15px;
            color: #4facfe;
            font-size: 1.1em;
            border-bottom: 2px solid #e8f4f8;
            padding-bottom: 8px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            user-select: none;
        }

        .control-section.collapsed h3 {
            margin-bottom: 0;
            border-bottom: none;
            padding: 15px 20px;
        }

        .toggle-icon {
            font-size: 1.2em;
            transition: transform 0.3s ease;
        }

        .control-section.collapsed .toggle-icon {
            transform: rotate(-90deg);
        }

        .control-content {
            transition: all 0.3s ease;
            overflow: hidden;
        }

        .control-section.collapsed .control-content {
            max-height: 0;
            opacity: 0;
            padding: 0 20px;
        }

        .control-group {
            margin-bottom: 20px;
        }

        .control-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #555;
            font-size: 0.9em;
        }

        .control-row {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .control-row input[type="range"] {
            flex: 1;
            height: 6px;
            background: #ddd;
            border-radius: 3px;
            outline: none;
            -webkit-appearance: none;
        }

        .control-row input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            background: #4facfe;
            border-radius: 50%;
            cursor: pointer;
        }

        .control-row input[type="number"] {
            width: 50px;
            padding: 5px;
            border: 2px solid #ddd;
            border-radius: 5px;
            text-align: center;
            font-size: 0.9em;
        }

        .control-row span {
            color: #666;
            font-size: 0.8em;
            min-width: 20px;
        }

        .instruction {
            background: #e8f4f8;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 4px solid #4facfe;
        }

        .instruction h4 {
            margin-top: 0;
            color: #2c5282;
        }

        .instruction p {
            margin: 5px 0;
            color: #2d3748;
            font-size: 0.9em;
        }

        .download-section {
            text-align: center;
            background: #f8f9fa;
            padding: 30px;
            border-radius: 15px;
        }

        .download-btn {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(79, 172, 254, 0.3);
        }

        .download-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(79, 172, 254, 0.4);
        }

        .download-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .reset-btn {
            background: #ff6b6b;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 0.9em;
            cursor: pointer;
            margin-left: 10px;
        }

        @media (max-width: 768px) {
            .upload-section {
                grid-template-columns: 1fr;
            }
            
            .workspace {
                grid-template-columns: 1fr;
            }
            
            .controls {
                order: -1;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ç°¡å˜ç”»åƒåˆæˆãƒ„ãƒ¼ãƒ«</h1>
            <p>ãƒ‰ãƒ©ãƒƒã‚°æ“ä½œã§ç°¡å˜ã«ä½ç½®èª¿æ•´ã§ãã‚‹åˆæˆãƒ„ãƒ¼ãƒ«</p>
        </div>

        <div class="content">
            <div class="upload-section">
                <div class="upload-box" onclick="document.getElementById('backgroundInput').click()">
                    <div class="upload-icon">ğŸ–¼ï¸</div>
                    <h3>èƒŒæ™¯ç”»åƒ</h3>
                    <p>ã‚¯ãƒªãƒƒã‚¯ã¾ãŸã¯ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—</p>
                    <input type="file" id="backgroundInput" accept="image/*">
                    <button class="clear-btn" id="clearBackground" onclick="event.stopPropagation(); clearBackground()">Ã—</button>
                    <img id="backgroundPreview" class="preview-image" style="display: none;">
                </div>

                <div class="upload-box" onclick="document.getElementById('overlayInput').click()">
                    <div class="upload-icon">ğŸ¨</div>
                    <h3>åˆæˆç”»åƒ</h3>
                    <p>ã‚¯ãƒªãƒƒã‚¯ã¾ãŸã¯ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—</p>
                    <input type="file" id="overlayInput" accept="image/*">
                    <button class="clear-btn" id="clearOverlay" onclick="event.stopPropagation(); clearOverlay()">Ã—</button>
                    <img id="overlayPreview" class="preview-image" style="display: none;">
                </div>
            </div>

            <div class="workspace">
                <div class="canvas-container">
                    <canvas id="mainCanvas" class="main-canvas" style="display: none;"></canvas>
                    <div id="canvasPlaceholder">
                        <h3>åˆæˆçµæœ</h3>
                        <p>ä¸¡æ–¹ã®ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã¨è¡¨ç¤ºã•ã‚Œã¾ã™</p>
                    </div>
                </div>

                <div class="controls">
                    <div class="instruction">
                        <h4>ğŸ’¡ æ“ä½œæ–¹æ³•</h4>
                        <p>â€¢ åˆæˆç”»åƒã‚’ãƒ‰ãƒ©ãƒƒã‚°ã—ã¦ä½ç½®èª¿æ•´</p>
                        <p>â€¢ ãƒã‚¦ã‚¹ãƒ›ã‚¤ãƒ¼ãƒ«ã§ã‚µã‚¤ã‚ºèª¿æ•´</p>
                        <p>â€¢ Shiftã‚­ãƒ¼ + ãƒ‰ãƒ©ãƒƒã‚°ã§å›è»¢</p>
                        <p>â€¢ ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã§å·¦å³åè»¢</p>
                        <p>â€¢ æ¶ˆã—ã‚´ãƒ ãƒ¢ãƒ¼ãƒ‰ã§ä¸è¦éƒ¨åˆ†ã‚’æ¶ˆå»</p>
                        <p>â€¢ ãƒšãƒ³ãƒ»ã‚¿ãƒƒãƒæ“ä½œã«å¯¾å¿œ</p>
                        <p>â€¢ ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã§è‰²èª¿ãƒ»æ˜åº¦èª¿æ•´</p>
                    </div>

                    <div class="control-section" id="positionSection">
                        <h3 onclick="toggleSection('positionSection')">
                            ğŸ¯ ä½ç½®ãƒ»å¤‰å½¢
                            <span class="toggle-icon">â–¼</span>
                        </h3>
                        
                        <div class="control-content">
                            <div class="control-group">
                                <label>ã‚µã‚¤ã‚º</label>
                                <div class="control-row">
                                    <input type="range" id="scaleSlider" min="10" max="300" value="100">
                                    <input type="number" id="scaleInput" min="10" max="300" value="100">
                                    <span>%</span>
                                </div>
                            </div>

                            <div class="control-group">
                                <label>å›è»¢</label>
                                <div class="control-row">
                                    <input type="range" id="rotationSlider" min="-180" max="180" value="0">
                                    <input type="number" id="rotationInput" min="-180" max="180" value="0">
                                    <span>Â°</span>
                                </div>
                            </div>

                            <div class="control-group">
                                <label>é€æ˜åº¦</label>
                                <div class="control-row">
                                    <input type="range" id="opacitySlider" min="0" max="100" value="100">
                                    <input type="number" id="opacityInput" min="0" max="100" value="100">
                                    <span>%</span>
                                </div>
                            </div>

                            <div class="control-group">
                                <label>å·¦å³åè»¢</label>
                                <div class="control-row">
                                    <input type="checkbox" id="flipHorizontal" style="width: auto; margin-right: 10px;">
                                    <span>æ°´å¹³åè»¢</span>
                                </div>
                            </div>

                            <div class="control-group">
                                <label>æ¶ˆã—ã‚´ãƒ ãƒ¢ãƒ¼ãƒ‰</label>
                                <div class="control-row">
                                    <input type="checkbox" id="eraserMode" style="width: auto; margin-right: 10px;">
                                    <span>æ¶ˆå»ãƒ¢ãƒ¼ãƒ‰</span>
                                </div>
                            </div>

                            <div class="control-group" id="eraserSizeGroup" style="display: none;">
                                <label>æ¶ˆã—ã‚´ãƒ ã‚µã‚¤ã‚º</label>
                                <div class="control-row">
                                    <input type="range" id="eraserSizeSlider" min="5" max="100" value="20">
                                    <input type="number" id="eraserSizeInput" min="5" max="100" value="20">
                                    <span>px</span>
                                </div>
                            </div>

                            <button class="reset-btn" onclick="resetPosition()">ä½ç½®ãƒªã‚»ãƒƒãƒˆ</button>
                            <button class="reset-btn" onclick="resetEraser()" id="resetEraserBtn" style="display: none;">æ¶ˆå»ãƒªã‚»ãƒƒãƒˆ</button>
                        </div>
                    </div>

                    <div class="control-section" id="colorSection">
                        <h3 onclick="toggleSection('colorSection')">
                            ğŸ¨ è‰²èª¿èª¿æ•´
                            <span class="toggle-icon">â–¼</span>
                        </h3>
                        
                        <div class="control-content">
                            <div class="control-group">
                                <label>æ˜åº¦</label>
                                <div class="control-row">
                                    <input type="range" id="brightnessSlider" min="0" max="200" value="100">
                                    <input type="number" id="brightnessInput" min="0" max="200" value="100">
                                    <span>%</span>
                                </div>
                            </div>

                            <div class="control-group">
                                <label>ã‚³ãƒ³ãƒˆãƒ©ã‚¹ãƒˆ</label>
                                <div class="control-row">
                                    <input type="range" id="contrastSlider" min="0" max="200" value="100">
                                    <input type="number" id="contrastInput" min="0" max="200" value="100">
                                    <span>%</span>
                                </div>
                            </div>

                            <div class="control-group">
                                <label>å½©åº¦</label>
                                <div class="control-row">
                                    <input type="range" id="saturationSlider" min="0" max="200" value="100">
                                    <input type="number" id="saturationInput" min="0" max="200" value="100">
                                    <span>%</span>
                                </div>
                            </div>

                            <div class="control-group">
                                <label>è‰²ç›¸</label>
                                <div class="control-row">
                                    <input type="range" id="hueSlider" min="-180" max="180" value="0">
                                    <input type="number" id="hueInput" min="-180" max="180" value="0">
                                    <span>Â°</span>
                                </div>
                            </div>

                            <button class="reset-btn" onclick="resetColors()">è‰²èª¿ãƒªã‚»ãƒƒãƒˆ</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="download-section">
                <button id="downloadBtn" class="download-btn" disabled>ç”»åƒã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
            </div>
        </div>
    </div>

    <script>
        let backgroundImage = null;
        let overlayImage = null;
        let canvas = null;
        let ctx = null;
        
        // é€éç”»åƒã®çŠ¶æ…‹
        let overlayState = {
            x: 0,
            y: 0,
            scale: 1,
            rotation: 0,
            opacity: 1,
            brightness: 1,
            contrast: 1,
            saturation: 1,
            hue: 0,
            flipHorizontal: false,
            isDragging: false,
            isRotating: false,
            dragStartX: 0,
            dragStartY: 0,
            initialX: 0,
            initialY: 0
        };

        // æ¶ˆã—ã‚´ãƒ é–¢é€£
        let eraserState = {
            isActive: false,
            size: 20,
            isErasing: false,
            lastX: 0,
            lastY: 0,
            pressure: 1.0 // ãƒšãƒ³åœ§åŠ›å¯¾å¿œ
        };

        // åˆæˆç”»åƒã®ãƒã‚¹ã‚¯ã‚­ãƒ£ãƒ³ãƒã‚¹ï¼ˆæ¶ˆå»éƒ¨åˆ†ã‚’è¨˜éŒ²ï¼‰
        let maskCanvas = null;
        let maskCtx = null;

        // åˆæœŸåŒ–
        function init() {
            canvas = document.getElementById('mainCanvas');
            ctx = canvas.getContext('2d');
            
            setupEventListeners();
        }

        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®è¨­å®š
        function setupEventListeners() {
            // ãƒ•ã‚¡ã‚¤ãƒ«å…¥åŠ›
            document.getElementById('backgroundInput').addEventListener('change', handleBackgroundUpload);
            document.getElementById('overlayInput').addEventListener('change', handleOverlayUpload);

            // ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—
            setupDragAndDrop();

            // ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«
            setupControls();

            // ã‚­ãƒ£ãƒ³ãƒã‚¹ã®ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ã‚·ãƒ§ãƒ³
            setupCanvasInteraction();

            // å·¦å³åè»¢ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹
            document.getElementById('flipHorizontal').addEventListener('change', (e) => {
                overlayState.flipHorizontal = e.target.checked;
                updateComposition();
            });

            // æ¶ˆã—ã‚´ãƒ ãƒ¢ãƒ¼ãƒ‰
            document.getElementById('eraserMode').addEventListener('change', (e) => {
                eraserState.isActive = e.target.checked;
                updateEraserUI();
                updateCanvasCursor();
            });

            // æ¶ˆã—ã‚´ãƒ ã‚µã‚¤ã‚º
            const eraserSizeSlider = document.getElementById('eraserSizeSlider');
            const eraserSizeInput = document.getElementById('eraserSizeInput');
            
            eraserSizeSlider.addEventListener('input', (e) => {
                eraserState.size = parseInt(e.target.value);
                eraserSizeInput.value = eraserState.size;
            });
            
            eraserSizeInput.addEventListener('input', (e) => {
                eraserState.size = parseInt(e.target.value);
                eraserSizeSlider.value = eraserState.size;
            });

            // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
            document.getElementById('downloadBtn').addEventListener('click', downloadImage);
        }

        // ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«è¨­å®š
        function setupControls() {
            const controls = [
                { name: 'scale', property: 'scale', multiplier: 0.01 },
                { name: 'rotation', property: 'rotation', multiplier: 1 },
                { name: 'opacity', property: 'opacity', multiplier: 0.01 },
                { name: 'brightness', property: 'brightness', multiplier: 0.01 },
                { name: 'contrast', property: 'contrast', multiplier: 0.01 },
                { name: 'saturation', property: 'saturation', multiplier: 0.01 },
                { name: 'hue', property: 'hue', multiplier: 1 }
            ];

            controls.forEach(control => {
                const slider = document.getElementById(control.name + 'Slider');
                const input = document.getElementById(control.name + 'Input');
                
                slider.addEventListener('input', (e) => {
                    const value = parseInt(e.target.value);
                    input.value = value;
                    overlayState[control.property] = value * control.multiplier;
                    updateComposition();
                });
                
                input.addEventListener('input', (e) => {
                    const value = parseInt(e.target.value);
                    slider.value = value;
                    overlayState[control.property] = value * control.multiplier;
                    updateComposition();
                });
            });
        }

        // ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ã‚·ãƒ§ãƒ³è¨­å®š
        function setupCanvasInteraction() {
            // ãƒã‚¦ã‚¹ã‚¤ãƒ™ãƒ³ãƒˆ
            canvas.addEventListener('mousedown', handleMouseDown);
            canvas.addEventListener('mousemove', handleMouseMove);
            canvas.addEventListener('mouseup', handleMouseUp);
            canvas.addEventListener('wheel', handleWheel);
            canvas.addEventListener('mouseleave', handleMouseUp);

            // ã‚¿ãƒƒãƒã‚¤ãƒ™ãƒ³ãƒˆï¼ˆãƒšãƒ³å¯¾å¿œï¼‰
            canvas.addEventListener('touchstart', handleTouchStart, { passive: false });
            canvas.addEventListener('touchmove', handleTouchMove, { passive: false });
            canvas.addEventListener('touchend', handleTouchEnd, { passive: false });
            canvas.addEventListener('touchcancel', handleTouchEnd, { passive: false });

            // ãƒã‚¤ãƒ³ã‚¿ãƒ¼ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆã‚ˆã‚Šé«˜ç²¾åº¦ãªãƒšãƒ³æ“ä½œï¼‰
            if (window.PointerEvent) {
                canvas.addEventListener('pointerdown', handlePointerDown);
                canvas.addEventListener('pointermove', handlePointerMove);
                canvas.addEventListener('pointerup', handlePointerUp);
                canvas.addEventListener('pointercancel', handlePointerUp);
            }
        }

        // åº§æ¨™å–å¾—ã®å…±é€šé–¢æ•°
        function getCanvasCoordinates(clientX, clientY) {
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            return {
                x: (clientX - rect.left) * scaleX,
                y: (clientY - rect.top) * scaleY
            };
        }

        // ãƒã‚¦ã‚¹ãƒ€ã‚¦ãƒ³
        function handleMouseDown(e) {
            if (!backgroundImage || !overlayImage) return;
            e.preventDefault();

            const coords = getCanvasCoordinates(e.clientX, e.clientY);
            handleInteractionStart(coords.x, coords.y, e.shiftKey, 1.0);
        }

        // ãƒã‚¦ã‚¹ç§»å‹•
        function handleMouseMove(e) {
            if (!backgroundImage || !overlayImage) return;
            e.preventDefault();

            const coords = getCanvasCoordinates(e.clientX, e.clientY);
            handleInteractionMove(coords.x, coords.y, 1.0);
        }

        // ãƒã‚¦ã‚¹ã‚¢ãƒƒãƒ—
        function handleMouseUp(e) {
            if (e) e.preventDefault();
            handleInteractionEnd();
        }

        // ãƒ›ã‚¤ãƒ¼ãƒ«å‡¦ç†ï¼ˆã‚µã‚¤ã‚ºèª¿æ•´ï¼‰
        function handleWheel(e) {
            if (!backgroundImage || !overlayImage || eraserState.isActive) return;
            
            e.preventDefault();
            
            const scaleDelta = e.deltaY > 0 ? -5 : 5;
            const newScale = Math.max(10, Math.min(300, Math.round((overlayState.scale * 100) + scaleDelta)));
            
            overlayState.scale = newScale / 100;
            
            // UIæ›´æ–°
            document.getElementById('scaleSlider').value = newScale;
            document.getElementById('scaleInput').value = newScale;
            
            updateComposition();
        }

        // é€éç”»åƒã®ç¯„å›²å†…ã‹ãƒã‚§ãƒƒã‚¯
        function isPointInOverlay(x, y) {
            const overlayWidth = overlayImage.width * overlayState.scale;
            const overlayHeight = overlayImage.height * overlayState.scale;
            
            const left = overlayState.x - overlayWidth / 2;
            const right = overlayState.x + overlayWidth / 2;
            const top = overlayState.y - overlayHeight / 2;
            const bottom = overlayState.y + overlayHeight / 2;
            
            return x >= left && x <= right && y >= top && y <= bottom;
        }

        // ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—è¨­å®š
        function setupDragAndDrop() {
            const uploadBoxes = document.querySelectorAll('.upload-box');
            
            uploadBoxes.forEach(box => {
                box.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    box.classList.add('dragover');
                });
                
                box.addEventListener('dragleave', () => {
                    box.classList.remove('dragover');
                });
                
                box.addEventListener('drop', (e) => {
                    e.preventDefault();
                    box.classList.remove('dragover');
                    
                    const files = e.dataTransfer.files;
                    if (files.length > 0) {
                        const isBackground = box.querySelector('#backgroundInput');
                        if (isBackground) {
                            handleBackgroundFile(files[0]);
                        } else {
                            handleOverlayFile(files[0]);
                        }
                    }
                });
            });
        }

        // èƒŒæ™¯ç”»åƒå‡¦ç†
        function handleBackgroundUpload(e) {
            const file = e.target.files[0];
            if (file) handleBackgroundFile(file);
        }

        function handleBackgroundFile(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.onload = () => {
                    backgroundImage = img;
                    updatePreview('background');
                    updateComposition();
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        // åˆæˆç”»åƒå‡¦ç†
        function handleOverlayUpload(e) {
            const file = e.target.files[0];
            if (file) handleOverlayFile(file);
        }

        function handleOverlayFile(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.onload = () => {
                    overlayImage = img;
                    updatePreview('overlay');
                    resetPosition();
                    initializeMask(); // ãƒã‚¹ã‚¯ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚’åˆæœŸåŒ–
                    updateComposition();
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ›´æ–°
        function updatePreview(type) {
            if (type === 'background' && backgroundImage) {
                const preview = document.getElementById('backgroundPreview');
                const clearBtn = document.getElementById('clearBackground');
                
                preview.src = backgroundImage.src;
                preview.style.display = 'block';
                clearBtn.style.display = 'block';
            } else if (type === 'overlay' && overlayImage) {
                const preview = document.getElementById('overlayPreview');
                const clearBtn = document.getElementById('clearOverlay');
                
                preview.src = overlayImage.src;
                preview.style.display = 'block';
                clearBtn.style.display = 'block';
            }
        }

        // ç”»åƒã‚¯ãƒªã‚¢
        function clearBackground() {
            backgroundImage = null;
            document.getElementById('backgroundPreview').style.display = 'none';
            document.getElementById('clearBackground').style.display = 'none';
            document.getElementById('backgroundInput').value = '';
            updateComposition();
        }

        function clearOverlay() {
            overlayImage = null;
            document.getElementById('overlayPreview').style.display = 'none';
            document.getElementById('clearOverlay').style.display = 'none';
            document.getElementById('overlayInput').value = '';
            
            // æ¶ˆã—ã‚´ãƒ é–¢é€£ã®UIã‚’ãƒªã‚»ãƒƒãƒˆ
            document.getElementById('eraserMode').checked = false;
            eraserState.isActive = false;
            updateEraserUI();
            
            updateComposition();
        }

        // ä½ç½®ãƒªã‚»ãƒƒãƒˆ
        function resetPosition() {
            if (backgroundImage) {
                overlayState.x = backgroundImage.width / 2;
                overlayState.y = backgroundImage.height / 2;
                overlayState.scale = 1;
                overlayState.rotation = 0;
                overlayState.flipHorizontal = false;
                
                // UIæ›´æ–°
                document.getElementById('scaleSlider').value = 100;
                document.getElementById('scaleInput').value = 100;
                document.getElementById('rotationSlider').value = 0;
                document.getElementById('rotationInput').value = 0;
                document.getElementById('flipHorizontal').checked = false;
                
                updateComposition();
            }
        }

        // è‰²èª¿ãƒªã‚»ãƒƒãƒˆ
        function resetColors() {
            overlayState.opacity = 1;
            overlayState.brightness = 1;
            overlayState.contrast = 1;
            overlayState.saturation = 1;
            overlayState.hue = 0;
            
            // UIæ›´æ–°
            document.getElementById('opacitySlider').value = 100;
            document.getElementById('opacityInput').value = 100;
            document.getElementById('brightnessSlider').value = 100;
            document.getElementById('brightnessInput').value = 100;
            document.getElementById('contrastSlider').value = 100;
            document.getElementById('contrastInput').value = 100;
            document.getElementById('saturationSlider').value = 100;
            document.getElementById('saturationInput').value = 100;
            document.getElementById('hueSlider').value = 0;
            document.getElementById('hueInput').value = 0;
            
            updateComposition();
        }

        // åˆæˆå‡¦ç†
        function updateComposition() {
            if (!backgroundImage || !overlayImage) {
                canvas.style.display = 'none';
                document.getElementById('canvasPlaceholder').style.display = 'block';
                document.getElementById('downloadBtn').disabled = true;
                return;
            }

            // ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚µã‚¤ã‚ºè¨­å®š
            canvas.width = backgroundImage.width;
            canvas.height = backgroundImage.height;

            // èƒŒæ™¯æç”»
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.drawImage(backgroundImage, 0, 0);

            // åˆæˆç”»åƒã®è‰²èª¿æ•´ã¨ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼è¨­å®š
            const filters = [
                `brightness(${overlayState.brightness})`,
                `contrast(${overlayState.contrast})`,
                `saturate(${overlayState.saturation})`,
                `hue-rotate(${overlayState.hue}deg)`
            ];
            ctx.filter = filters.join(' ');

            // åˆæˆç”»åƒæç”»ï¼ˆãƒã‚¹ã‚¯ã‚’é©ç”¨ï¼‰
            ctx.save();
            ctx.globalAlpha = overlayState.opacity;
            ctx.translate(overlayState.x, overlayState.y);
            ctx.rotate(overlayState.rotation * Math.PI / 180);
            
            // å·¦å³åè»¢ã®å‡¦ç†
            if (overlayState.flipHorizontal) {
                ctx.scale(-1, 1);
            }
            
            const overlayWidth = overlayImage.width * overlayState.scale;
            const overlayHeight = overlayImage.height * overlayState.scale;
            
            // ä¸€æ™‚ã‚­ãƒ£ãƒ³ãƒã‚¹ã§åˆæˆç”»åƒã¨ãƒã‚¹ã‚¯ã‚’åˆæˆ
            const tempCanvas = document.createElement('canvas');
            const tempCtx = tempCanvas.getContext('2d');
            tempCanvas.width = overlayWidth;
            tempCanvas.height = overlayHeight;
            
            // åˆæˆç”»åƒã‚’æç”»
            tempCtx.drawImage(overlayImage, 0, 0, overlayWidth, overlayHeight);
            
            // ãƒã‚¹ã‚¯ã‚’é©ç”¨ï¼ˆæ¶ˆå»éƒ¨åˆ†ã‚’é€æ˜ã«ã™ã‚‹ï¼‰
            if (maskCanvas) {
                tempCtx.globalCompositeOperation = 'destination-out';
                tempCtx.drawImage(maskCanvas, 0, 0, overlayWidth, overlayHeight);
            }
            
            // æœ€çµ‚çµæœã‚’æç”»
            ctx.drawImage(tempCanvas, -overlayWidth / 2, -overlayHeight / 2);
            ctx.restore();

            // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’ãƒªã‚»ãƒƒãƒˆ
            ctx.filter = 'none';

            // è¡¨ç¤ºæ›´æ–°
            canvas.style.display = 'block';
            document.getElementById('canvasPlaceholder').style.display = 'none';
            document.getElementById('downloadBtn').disabled = false;
        }

        // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
        function downloadImage() {
            if (!canvas) return;

            // ç¾åœ¨ã®æ—¥æ™‚ã‚’å–å¾—ã—ã¦ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
            const now = new Date();
            const year = now.getFullYear().toString().slice(-2); // å¹´ã®ä¸‹2æ¡
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const seconds = String(now.getSeconds()).padStart(2, '0');
            
            const timestamp = `_${year}${month}${day}_${hours}${minutes}${seconds}`;
            const filename = `composite_image${timestamp}.png`;

            canvas.toBlob((blob) => {
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }, 'image/png');
        }

        // ã‚»ã‚¯ã‚·ãƒ§ãƒ³æŠ˜ã‚Šç•³ã¿æ©Ÿèƒ½
        function toggleSection(sectionId) {
            const section = document.getElementById(sectionId);
            section.classList.toggle('collapsed');
        }

        // ãƒã‚¹ã‚¯ã‚­ãƒ£ãƒ³ãƒã‚¹åˆæœŸåŒ–
        function initializeMask() {
            if (!overlayImage) return;
            
            maskCanvas = document.createElement('canvas');
            maskCtx = maskCanvas.getContext('2d');
            maskCanvas.width = overlayImage.width;
            maskCanvas.height = overlayImage.height;
            
            // é€æ˜ã§åˆæœŸåŒ–
            maskCtx.clearRect(0, 0, maskCanvas.width, maskCanvas.height);
        }

        // æ¶ˆã—ã‚´ãƒ UIæ›´æ–°
        function updateEraserUI() {
            const eraserSizeGroup = document.getElementById('eraserSizeGroup');
            const resetEraserBtn = document.getElementById('resetEraserBtn');
            
            if (eraserState.isActive) {
                eraserSizeGroup.style.display = 'block';
                resetEraserBtn.style.display = 'inline-block';
            } else {
                eraserSizeGroup.style.display = 'none';
                resetEraserBtn.style.display = 'none';
            }
        }

        // ã‚«ãƒ¼ã‚½ãƒ«æ›´æ–°
        function updateCanvasCursor() {
            if (eraserState.isActive) {
                canvas.classList.add('eraser-mode');
            } else {
                canvas.classList.remove('eraser-mode');
                canvas.style.cursor = overlayState.isDragging ? 'grabbing' : 'grab';
            }
        }

        // æŒ‡å®šç‚¹ã§æ¶ˆå»
        function eraseAtPoint(x, y, pressure = 1.0) {
            if (!maskCanvas || !overlayImage) return;
            
            // åˆæˆç”»åƒã®åº§æ¨™ç³»ã«å¤‰æ›
            const localX = (x - overlayState.x) / overlayState.scale + overlayImage.width / 2;
            const localY = (y - overlayState.y) / overlayState.scale + overlayImage.height / 2;
            
            maskCtx.globalCompositeOperation = 'source-over';
            maskCtx.fillStyle = 'white';
            maskCtx.beginPath();
            // ãƒšãƒ³åœ§åŠ›ã§ã‚µã‚¤ã‚ºã‚’èª¿æ•´
            maskCtx.arc(localX, localY, (eraserState.size * pressure) / overlayState.scale, 0, Math.PI * 2);
            maskCtx.fill();
            
            updateComposition();
        }

        // ç·šã§æ¶ˆå»
        function eraseLineTo(x, y, pressure = 1.0) {
            if (!maskCanvas || !overlayImage) return;
            
            const localX = (x - overlayState.x) / overlayState.scale + overlayImage.width / 2;
            const localY = (y - overlayState.y) / overlayState.scale + overlayImage.height / 2;
            const lastLocalX = (eraserState.lastX - overlayState.x) / overlayState.scale + overlayImage.width / 2;
            const lastLocalY = (eraserState.lastY - overlayState.y) / overlayState.scale + overlayImage.height / 2;
            
            maskCtx.globalCompositeOperation = 'source-over';
            maskCtx.strokeStyle = 'white';
            // ãƒšãƒ³åœ§åŠ›ã§ã‚µã‚¤ã‚ºã‚’èª¿æ•´
            maskCtx.lineWidth = (eraserState.size * 2 * pressure) / overlayState.scale;
            maskCtx.lineCap = 'round';
            maskCtx.beginPath();
            maskCtx.moveTo(lastLocalX, lastLocalY);
            maskCtx.lineTo(localX, localY);
            maskCtx.stroke();
            
            updateComposition();
        }

        // æ¶ˆå»ãƒªã‚»ãƒƒãƒˆ
        function resetEraser() {
            if (maskCanvas) {
                maskCtx.clearRect(0, 0, maskCanvas.width, maskCanvas.height);
                updateComposition();
            }
        }

        // ã‚¿ãƒƒãƒã‚¤ãƒ™ãƒ³ãƒˆå‡¦ç†
        function handleTouchStart(e) {
            if (!backgroundImage || !overlayImage) return;
            e.preventDefault();
            
            if (e.touches.length === 1) {
                const touch = e.touches[0];
                const coords = getCanvasCoordinates(touch.clientX, touch.clientY);
                handleInteractionStart(coords.x, coords.y, false, 1.0);
            }
        }

        function handleTouchMove(e) {
            if (!backgroundImage || !overlayImage) return;
            e.preventDefault();
            
            if (e.touches.length === 1) {
                const touch = e.touches[0];
                const coords = getCanvasCoordinates(touch.clientX, touch.clientY);
                handleInteractionMove(coords.x, coords.y, 1.0);
            }
        }

        function handleTouchEnd(e) {
            e.preventDefault();
            handleInteractionEnd();
        }

        // ãƒã‚¤ãƒ³ã‚¿ãƒ¼ã‚¤ãƒ™ãƒ³ãƒˆå‡¦ç†ï¼ˆé«˜ç²¾åº¦ãƒšãƒ³å¯¾å¿œï¼‰
        function handlePointerDown(e) {
            if (!backgroundImage || !overlayImage) return;
            e.preventDefault();
            
            const coords = getCanvasCoordinates(e.clientX, e.clientY);
            const pressure = e.pressure || 1.0;
            handleInteractionStart(coords.x, coords.y, e.shiftKey, pressure);
        }

        function handlePointerMove(e) {
            if (!backgroundImage || !overlayImage) return;
            e.preventDefault();
            
            const coords = getCanvasCoordinates(e.clientX, e.clientY);
            const pressure = e.pressure || 1.0;
            handleInteractionMove(coords.x, coords.y, pressure);
        }

        function handlePointerUp(e) {
            e.preventDefault();
            handleInteractionEnd();
        }

        // å…±é€šã®ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ã‚·ãƒ§ãƒ³å‡¦ç†
        function handleInteractionStart(x, y, isShiftKey, pressure) {
            eraserState.pressure = pressure;
            
            if (eraserState.isActive) {
                // æ¶ˆã—ã‚´ãƒ ãƒ¢ãƒ¼ãƒ‰
                eraserState.isErasing = true;
                eraserState.lastX = x;
                eraserState.lastY = y;
                eraseAtPoint(x, y, pressure);
            } else if (isPointInOverlay(x, y)) {
                // é€šå¸¸ã®ç§»å‹•ãƒ»å›è»¢ãƒ¢ãƒ¼ãƒ‰
                overlayState.isDragging = true;
                overlayState.isRotating = isShiftKey;
                overlayState.dragStartX = x;
                overlayState.dragStartY = y;
                overlayState.initialX = overlayState.x;
                overlayState.initialY = overlayState.y;
                
                canvas.style.cursor = overlayState.isRotating ? 'grab' : 'grabbing';
            }
        }

        function handleInteractionMove(x, y, pressure) {
            eraserState.pressure = pressure;
            
            if (eraserState.isErasing) {
                // æ¶ˆã—ã‚´ãƒ ã§ç·šã‚’æã
                eraseLineTo(x, y, pressure);
                eraserState.lastX = x;
                eraserState.lastY = y;
                return;
            }

            if (!overlayState.isDragging) return;

            if (overlayState.isRotating) {
                // å›è»¢å‡¦ç†
                const centerX = overlayState.x;
                const centerY = overlayState.y;
                const angle1 = Math.atan2(overlayState.dragStartY - centerY, overlayState.dragStartX - centerX);
                const angle2 = Math.atan2(y - centerY, x - centerX);
                const deltaAngle = (angle2 - angle1) * 180 / Math.PI;
                
                overlayState.rotation = (overlayState.rotation + deltaAngle) % 360;
                
                // UIæ›´æ–°
                document.getElementById('rotationSlider').value = Math.round(overlayState.rotation);
                document.getElementById('rotationInput').value = Math.round(overlayState.rotation);
                
                overlayState.dragStartX = x;
                overlayState.dragStartY = y;
            } else {
                // ç§»å‹•å‡¦ç†
                overlayState.x = overlayState.initialX + (x - overlayState.dragStartX);
                overlayState.y = overlayState.initialY + (y - overlayState.dragStartY);
            }

            updateComposition();
        }

        function handleInteractionEnd() {
            overlayState.isDragging = false;
            overlayState.isRotating = false;
            eraserState.isErasing = false;
            updateCanvasCursor();
        }

        // åˆæœŸåŒ–å®Ÿè¡Œ
        init();
    </script>
</body>
</html>