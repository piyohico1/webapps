<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>piyohico apps</title>
    <link rel="icon"
        href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%2216%22 height=%2216%22 viewBox=%220 0 16 16%22><text x=%220%22 y=%2214%22 font-size=%2216%22>&#x1f423;</text></svg>"
        type="image/svg+xml">

    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-MSTVN0KCF9"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());

        gtag('config', 'G-MSTVN0KCF9');
    </script>

    <!-- Fonts & Icons -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Space+Grotesk:wght@700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <link rel="stylesheet" href="style.css">

    <!-- CSP (Content Security Policy) - Basic protection -->
    <meta http-equiv="Content-Security-Policy"
        content="default-src 'self' https://www.googletagmanager.com https://www.google-analytics.com; script-src 'self' 'unsafe-inline' https://www.googletagmanager.com https://www.google-analytics.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://cdnjs.cloudflare.com; font-src 'self' https://fonts.gstatic.com https://cdnjs.cloudflare.com; img-src 'self' data: https://www.google-analytics.com; connect-src 'self' https://www.google-analytics.com;">
</head>

<body>
    <a href="https://twitter.com/intent/tweet?text=%E3%81%82%E3%82%8B%E3%81%A8%E4%BE%BF%E5%88%A9%E3%81%AA%E3%83%96%E3%83%A9%E3%82%A6%E3%82%B6%E3%82%A2%E3%83%97%E3%83%AA%20-%20piyohico%20apps&hashtags=piyohicoapps"
        class="share-button" target="_blank" rel="noopener noreferrer" aria-label="Xã§ã‚·ã‚§ã‚¢">
        <svg viewBox="0 0 24 24" aria-hidden="true" class="x-icon">
            <path
                d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z">
            </path>
        </svg>
    </a>
    <div class="container">
        <header class="header">
            <h1>piyohico apps</h1>
            <p>ã‚ã‚‹ã¨ä¾¿åˆ©ãªãƒ–ãƒ©ã‚¦ã‚¶ã‚¢ãƒ—ãƒª <a href="https://x.com/piyo621" target="_blank" rel="noopener noreferrer">@piyohico</a>
            </p>
        </header>

        <main>
            <!-- Update Link -->
            <div class="update-link-container">
                <a href="#" class="update-link" id="updates-trigger">
                    <i class="fas fa-history"></i> æ›´æ–°å±¥æ­´
                </a>
            </div>

            <!-- æ¤œç´¢ãƒãƒ¼ -->
            <div class="search-container">
                <i class="fas fa-search search-icon"></i>
                <input type="text" id="search-input" class="search-input" placeholder="ã‚¢ãƒ—ãƒªã‚’æ¤œç´¢ / Search..."
                    aria-label="ã‚¢ãƒ—ãƒªã‚’æ¤œç´¢">
            </div>

            <div class="apps-grid" id="apps-grid">
                <!-- ã‚¢ãƒ—ãƒªãƒªã‚¹ãƒˆã¯JavaScriptã§å‹•çš„ã«èª­ã¿è¾¼ã¾ã‚Œã¾ã™ -->
            </div>
        </main>

        <footer class="footer">
            <p>&copy; piyohico apps. All rights reserved.</p>
        </footer>
    </div>

    <!-- Update History Modal -->
    <div class="modal-overlay" id="update-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>æ›´æ–°å±¥æ­´</h2>
                <button class="modal-close" id="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <ul class="update-list" id="update-list">
                    <!-- Dynamic Content -->
                </ul>
            </div>
        </div>
    </div>

    <script>
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã¨ã—ã¦ä¿æŒï¼ˆæ¤œç´¢ç”¨ï¼‰
        let allApps = [];

        // ã‚¢ãƒ—ãƒªãƒªã‚¹ãƒˆï¼ˆMarkdownå½¢å¼ï¼‰ã‚’èª­ã¿è¾¼ã‚“ã§è¡¨ç¤º
        // ã‚¢ãƒ—ãƒªãƒªã‚¹ãƒˆã¨å±¥æ­´ã‚’èª­ã¿è¾¼ã‚“ã§è¡¨ç¤º
        async function loadApps() {
            try {
                // ä¸¡æ–¹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¸¦åˆ—ã§å–å¾—
                const [appsRes, historyRes] = await Promise.all([
                    fetch('./apps.md'),
                    fetch('./history.md')
                ]);

                if (!appsRes.ok) throw new Error(`apps.md: ${appsRes.statusText}`);
                // history.md ã¯å¿…é ˆã§ã¯ãªã„ã‹ã‚‚ã—ã‚Œãªã„ãŒã€ä»Šå›ã¯ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã—ã¦ãŠã
                if (!historyRes.ok) console.warn(`history.md: ${historyRes.statusText}`);

                const appsText = await appsRes.text();
                const historyText = historyRes.ok ? await historyRes.text() : '';

                // Markdownãƒ‘ãƒ¼ã‚µãƒ¼
                allApps = parseAppsMarkdown(appsText);
                const historyItems = parseHistoryMarkdown(historyText);

                if (allApps.length === 0) {
                    throw new Error('ã‚¢ãƒ—ãƒªãƒªã‚¹ãƒˆãŒç©ºã§ã™');
                }

                renderApps(allApps);

                // å±¥æ­´ãƒªã‚¹ãƒˆã®çµåˆã¨ã‚½ãƒ¼ãƒˆ
                const combinedHistory = [...allApps, ...historyItems];
                combinedHistory.sort((a, b) => {
                    const dateA = getDateObject(a.updateDate || a.date);
                    const dateB = getDateObject(b.updateDate || b.date);
                    return dateB - dateA;
                });

                setupUpdateModal(combinedHistory);

                // æ¤œç´¢ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®è¨­å®š
                setupSearch();

            } catch (error) {
                console.error('ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ:', error);
                showError('ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
            }
        }

        // XSSå¯¾ç­–ï¼šHTMLç‰¹æ®Šæ–‡å­—ã®ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—
        function escapeHtml(text) {
            if (!text) return '';
            return text
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        function parseAppsMarkdown(markdown) {
            const apps = [];
            const lines = markdown.split('\n');
            let currentApp = null;

            for (const line of lines) {
                const trimmed = line.trim();

                if (trimmed.startsWith('## ')) {
                    if (currentApp) apps.push(currentApp);

                    const titleMatch = trimmed.match(/^## (.+?) (.+)/);
                    if (titleMatch) {
                        currentApp = {
                            type: 'app',
                            icon: titleMatch[1],
                            title: titleMatch[2],
                            description: '',
                            date: '',
                            updateDate: '',
                            link: '',
                            english: '',
                            englishDesc: ''
                        };
                    }
                } else if (trimmed.startsWith('**èª¬æ˜:**')) {
                    if (currentApp) currentApp.description = trimmed.replace('**èª¬æ˜:**', '').trim();
                } else if (trimmed.startsWith('**åˆ¶ä½œæ—¥:**')) {
                    if (currentApp) currentApp.date = trimmed.replace('**åˆ¶ä½œæ—¥:**', '').trim();
                } else if (trimmed.startsWith('**æ›´æ–°æ—¥:**')) {
                    if (currentApp) currentApp.updateDate = trimmed.replace('**æ›´æ–°æ—¥:**', '').trim();
                } else if (trimmed.startsWith('**è‹±èª:**')) {
                    if (currentApp) currentApp.english = trimmed.replace('**è‹±èª:**', '').trim();
                } else if (trimmed.startsWith('**è‹±èªèª¬æ˜:**')) {
                    if (currentApp) currentApp.englishDesc = trimmed.replace('**è‹±èªèª¬æ˜:**', '').trim();
                } else if (trimmed.startsWith('**ãƒªãƒ³ã‚¯:**')) {
                    if (currentApp) {
                        const linkMatch = trimmed.match(/\[(.+?)\]\((.+?)\)/);
                        if (linkMatch) currentApp.link = linkMatch[2];
                    }
                }
            }
            if (currentApp) apps.push(currentApp);
            return apps;
        }

        function parseHistoryMarkdown(markdown) {
            const items = [];
            if (!markdown) return items;

            const lines = markdown.split('\n');
            let currentItem = null;

            for (const line of lines) {
                const trimmed = line.trim();

                // ç©ºè¡Œã‚„ç‰¹å®šã®åŒºåˆ‡ã‚Šã§æ–°ã—ã„ã‚¢ã‚¤ãƒ†ãƒ ã¨ã¿ãªã™ã“ã¨ã‚‚ã§ãã‚‹ãŒ
                // ã“ã“ã§ã¯ **å†…å®¹:** ãŒæ¥ãŸã‚‰æ–°ã—ã„ã‚¢ã‚¤ãƒ†ãƒ ã®é–‹å§‹ã¨ã¿ãªã™ã‚·ãƒ³ãƒ—ãƒ«å®Ÿè£…ã«ã™ã‚‹
                if (trimmed.startsWith('**å†…å®¹:**')) {
                    if (currentItem) items.push(currentItem);
                    currentItem = {
                        type: 'history',
                        title: 'ã‚µã‚¤ãƒˆæ›´æ–°', // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¿ã‚¤ãƒˆãƒ«
                        icon: 'ğŸ ',       // å›ºå®šã‚¢ã‚¤ã‚³ãƒ³
                        description: trimmed.replace('**å†…å®¹:**', '').trim(),
                        date: '', // æ›´æ–°æ—¥ãŒå…¥ã‚‹
                        updateDate: '' // ã‚½ãƒ¼ãƒˆç”¨
                    };
                } else if (trimmed.startsWith('**æ›´æ–°æ—¥:**')) {
                    if (currentItem) {
                        const date = trimmed.replace('**æ›´æ–°æ—¥:**', '').trim();
                        currentItem.date = date;
                        currentItem.updateDate = date; // appsã¨åŒã˜ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã«ã—ã¦ãŠã
                    }
                }
            }
            if (currentItem) items.push(currentItem);
            return items;
        }

        function setupSearch() {
            const searchInput = document.getElementById('search-input');
            searchInput.addEventListener('input', (e) => {
                const query = e.target.value.toLowerCase();
                const filteredApps = allApps.filter(app => {
                    const matchTitle = app.title.toLowerCase().includes(query);
                    const matchDesc = app.description.toLowerCase().includes(query);
                    const matchEng = app.english && app.english.toLowerCase().includes(query);
                    const matchEngDesc = app.englishDesc && app.englishDesc.toLowerCase().includes(query);
                    return matchTitle || matchDesc || matchEng || matchEngDesc;
                });
                renderApps(filteredApps);
            });
        }

        function setupUpdateModal(apps) {
            const modal = document.getElementById('update-modal');
            const trigger = document.getElementById('updates-trigger');
            const close = document.getElementById('modal-close');
            const list = document.getElementById('update-list');

            if (!modal || !trigger || !close || !list) return;

            // Populate List
            // Populate List
            list.innerHTML = apps.map(app => {
                const date = app.updateDate || app.date;
                const safeDate = escapeHtml(date);

                // ã‚¢ãƒ—ãƒªã‹å±¥æ­´ã‹ã§è¡¨ç¤ºã‚’åˆ†ã‘ã‚‹
                if (app.type === 'history') {
                    // å±¥æ­´ã‚¢ã‚¤ãƒ†ãƒ 
                    const safeDesc = escapeHtml(app.description);
                    return `
                        <li class="update-item">
                            <div class="update-date">${safeDate}</div>
                            <div class="update-info">
                                <h4>
                                    <span class="status-badge updated">Site Update</span>
                                </h4>
                                <p style="display:block; font-size:0.85rem; color:#6b7280; margin-top:0.2rem;">${safeDesc}</p>
                            </div>
                        </li>
                    `;
                } else {
                    // ã‚¢ãƒ—ãƒª
                    const dateLabel = app.updateDate ? 'UPDATED' : 'CREATED';
                    const badgeClass = app.updateDate ? 'updated' : 'created';
                    const safeTitle = escapeHtml(app.title);
                    const safeIcon = app.icon;

                    return `
                        <li class="update-item">
                            <div class="update-date">${safeDate}</div>
                            <div class="update-info">
                                <h4>
                                    ${safeIcon} ${safeTitle}
                                    <span class="status-badge ${badgeClass}">${dateLabel}</span>
                                </h4>
                            </div>
                        </li>
                    `;
                }
            }).join('');

            // Event Listeners
            trigger.addEventListener('click', (e) => {
                e.preventDefault();
                modal.classList.add('active');
            });

            close.addEventListener('click', () => {
                modal.classList.remove('active');
            });

            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.classList.remove('active');
                }
            });

            // ESC key
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && modal.classList.contains('active')) {
                    modal.classList.remove('active');
                }
            });
        }

        function getDateObject(dateString) {
            if (!dateString) return new Date(0); // éå»ã®æ—¥ä»˜
            const dateMatch = dateString.match(/(\d{4})å¹´(\d{1,2})æœˆ(\d{1,2})æ—¥/);
            if (!dateMatch) return new Date(0);

            const year = parseInt(dateMatch[1]);
            const month = parseInt(dateMatch[2]) - 1;
            const day = parseInt(dateMatch[3]);

            return new Date(year, month, day);
        }

        function isNewApp(dateString) {
            if (!dateString) return false;

            const appDate = getDateObject(dateString);
            const now = new Date();

            // 30æ—¥ä»¥å†…ãªã‚‰Newã¨ã™ã‚‹
            const diffTime = Math.abs(now - appDate);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

            return diffDays <= 30;
        }

        function renderApps(apps) {
            const appsGrid = document.getElementById('apps-grid');
            appsGrid.innerHTML = '';

            if (apps.length === 0) {
                appsGrid.innerHTML = '<p style="text-align:center; grid-column:1/-1; color:#718096;">è©²å½“ã™ã‚‹ã‚¢ãƒ—ãƒªãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚</p>';
                return;
            }

            apps.forEach((app, index) => {
                const appCard = document.createElement('div');
                appCard.className = 'app-card';
                // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã®é…å»¶ã‚’è¿½åŠ 
                appCard.style.animationDelay = `${index * 0.05}s`;

                // æ›´æ–°æ—¥ãŒã‚ã‚Œã°ãã‚Œã‚’å„ªå…ˆã—ã¦NEWåˆ¤å®š
                const checkDate = app.updateDate || app.date;
                const isNew = isNewApp(checkDate);
                const newBadge = isNew ? '<div class="badge-new">NEW</div>' : '';

                // ã‚µãƒ‹ã‚¿ã‚¤ã‚ºã•ã‚ŒãŸå€¤ã‚’ä½¿ç”¨
                const safeTitle = escapeHtml(app.title);
                const safeDesc = escapeHtml(app.description);
                const safeDate = escapeHtml(app.date);
                const safeUpdateDate = escapeHtml(app.updateDate);
                const safeLink = escapeHtml(app.link);
                // ã‚¢ã‚¤ã‚³ãƒ³ã¯çµµæ–‡å­—å‰æãªã®ã§ãã®ã¾ã¾å‡ºã™ãŒã€å¿µã®ãŸã‚ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã—ã¦ã‚‚è‰¯ã„ãŒçµµæ–‡å­—ãŒå£Šã‚Œã‚‹å ´åˆã‚‚ã‚ã‚‹ã®ã§æ³¨æ„
                // ã“ã“ã§ã¯çµµæ–‡å­—1æ–‡å­—+Î±ã¨æƒ³å®šã—ã¦ãã®ã¾ã¾å‡ºã™ï¼ˆMarkdownã®ãƒ‘ãƒ¼ã‚¹ã§æŠ½å‡ºã•ã‚ŒãŸã‚‚ã®ï¼‰
                const safeIcon = app.icon;

                let dateDisplay = `<div class="app-date">${safeDate}</div>`;
                if (safeUpdateDate) {
                    dateDisplay = `<div class="app-date">ğŸ”„ ${safeUpdateDate}</div>`;
                }

                appCard.innerHTML = `
                    ${newBadge}
                    <h3>
                        <span class="app-icon">${safeIcon}</span>
                        ${safeTitle}
                    </h3>
                    <p>${safeDesc}</p>
                    <div class="card-footer">
                        ${dateDisplay}
                        <a href="${safeLink}" class="app-link" target="_blank" rel="noopener noreferrer" aria-label="${safeTitle}ã‚’é–‹ã">
                            <i class="fas fa-arrow-right"></i>
                        </a>
                    </div>
                `;

                // ã‚«ãƒ¼ãƒ‰å…¨ä½“ã‚’ã‚¯ãƒªãƒƒã‚¯å¯èƒ½ã«ã™ã‚‹
                appCard.addEventListener('click', (e) => {
                    // ãƒªãƒ³ã‚¯ãƒœã‚¿ãƒ³ãã®ã‚‚ã®ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸå ´åˆã¯é‡è¤‡å‡¦ç†ã—ãªã„
                    if (e.target.closest('.app-link')) return;

                    // ãƒ†ã‚­ã‚¹ãƒˆé¸æŠä¸­ã¯é·ç§»ã—ãªã„ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ“ãƒªãƒ†ã‚£å‘ä¸Šï¼‰
                    const selection = window.getSelection();
                    if (selection.toString().length > 0) return;

                    window.open(safeLink, '_blank', 'noopener,noreferrer');
                });

                appsGrid.appendChild(appCard);
            });
        }

        function showError(message) {
            const appsGrid = document.getElementById('apps-grid');
            appsGrid.innerHTML = `
                <div class="error-message">
                    <h3><i class="fas fa-exclamation-triangle"></i> ã‚¨ãƒ©ãƒ¼</h3>
                    <p>${escapeHtml(message)}</p>
                </div>
            `;
        }

        document.addEventListener('DOMContentLoaded', () => {
            loadApps();

            // ã‚·ã‚§ã‚¢ãƒœã‚¿ãƒ³ã«ç¾åœ¨ã®URLã‚’è¿½åŠ 
            const shareBtn = document.querySelector('.share-button');
            if (shareBtn) {
                const currentUrl = encodeURIComponent(window.location.href);
                const currentHref = shareBtn.getAttribute('href');
                shareBtn.setAttribute('href', `${currentHref}%0a&url=${currentUrl}`);
            }
        });
    </script>
</body>

</html>