<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>piyohico apps</title>
    <link rel="icon"
        href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%2216%22 height=%2216%22 viewBox=%220 0 16 16%22><text x=%220%22 y=%2214%22 font-size=%2216%22>&#x1f423;</text></svg>"
        type="image/svg+xml">

    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-MSTVN0KCF9"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());

        gtag('config', 'G-MSTVN0KCF9');
    </script>

    <!-- Fonts & Icons -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Space+Grotesk:wght@700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <link rel="stylesheet" href="style.css">

    <!-- CSP (Content Security Policy) - Basic protection -->
    <meta http-equiv="Content-Security-Policy"
        content="default-src 'self' https://www.googletagmanager.com https://www.google-analytics.com; script-src 'self' 'unsafe-inline' https://www.googletagmanager.com https://www.google-analytics.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://cdnjs.cloudflare.com; font-src 'self' https://fonts.gstatic.com https://cdnjs.cloudflare.com; img-src 'self' data: https://www.google-analytics.com; connect-src 'self' https://www.google-analytics.com;">
</head>

<body>
    <a href="https://twitter.com/intent/tweet?text=%E3%81%82%E3%82%8B%E3%81%A8%E4%BE%BF%E5%88%A9%E3%81%AA%E3%83%96%E3%83%A9%E3%82%A6%E3%82%B6%E3%82%A2%E3%83%97%E3%83%AA%20-%20piyohico%20apps"
        class="share-button" target="_blank" rel="noopener noreferrer" aria-label="Xã§ã‚·ã‚§ã‚¢">
        <svg viewBox="0 0 24 24" aria-hidden="true" class="x-icon">
            <path
                d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z">
            </path>
        </svg>
    </a>
    <div class="container">
        <header class="header">
            <h1>piyohico apps</h1>
            <p>ã‚ã‚‹ã¨ä¾¿åˆ©ãªãƒ–ãƒ©ã‚¦ã‚¶ã‚¢ãƒ—ãƒª <a href="https://x.com/piyo621" target="_blank" rel="noopener noreferrer">@piyohico</a>
            </p>
        </header>

        <main>
            <!-- æ¤œç´¢ãƒãƒ¼ -->
            <div class="search-container">
                <i class="fas fa-search search-icon"></i>
                <input type="text" id="search-input" class="search-input" placeholder="ã‚¢ãƒ—ãƒªã‚’æ¤œç´¢..." aria-label="ã‚¢ãƒ—ãƒªã‚’æ¤œç´¢">
            </div>

            <div class="apps-grid" id="apps-grid">
                <!-- ã‚¢ãƒ—ãƒªãƒªã‚¹ãƒˆã¯JavaScriptã§å‹•çš„ã«èª­ã¿è¾¼ã¾ã‚Œã¾ã™ -->
            </div>
        </main>

        <footer class="footer">
            <p>&copy; piyohico apps. All rights reserved.</p>
        </footer>
    </div>

    <script>
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã¨ã—ã¦ä¿æŒï¼ˆæ¤œç´¢ç”¨ï¼‰
        let allApps = [];

        // ã‚¢ãƒ—ãƒªãƒªã‚¹ãƒˆï¼ˆMarkdownå½¢å¼ï¼‰ã‚’èª­ã¿è¾¼ã‚“ã§è¡¨ç¤º
        async function loadApps() {
            try {
                const response = await fetch('./apps.md');

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const markdownText = await response.text();

                // Markdownãƒ‘ãƒ¼ã‚µãƒ¼
                allApps = parseAppsMarkdown(markdownText);

                if (allApps.length === 0) {
                    throw new Error('ã‚¢ãƒ—ãƒªãƒªã‚¹ãƒˆãŒç©ºã§ã™');
                }

                // æ—¥ä»˜ã§ã‚½ãƒ¼ãƒˆï¼ˆæ–°ã—ã„é †ï¼‰
                allApps.sort((a, b) => {
                    const dateA = getDateObject(a.updateDate || a.date);
                    const dateB = getDateObject(b.updateDate || b.date);
                    return dateB - dateA;
                });

                renderApps(allApps);

                // æ¤œç´¢ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®è¨­å®š
                setupSearch();

            } catch (error) {
                console.error('ã‚¢ãƒ—ãƒªãƒªã‚¹ãƒˆã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ:', error);
                showError('apps.mdãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
            }
        }

        // XSSå¯¾ç­–ï¼šHTMLç‰¹æ®Šæ–‡å­—ã®ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—
        function escapeHtml(text) {
            if (!text) return '';
            return text
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        function parseAppsMarkdown(markdown) {
            const apps = [];
            const lines = markdown.split('\n');
            let currentApp = null;

            for (const line of lines) {
                const trimmed = line.trim();

                if (trimmed.startsWith('## ')) {
                    if (currentApp) apps.push(currentApp);

                    const titleMatch = trimmed.match(/^## (.+?) (.+)/);
                    if (titleMatch) {
                        currentApp = {
                            icon: titleMatch[1],
                            title: titleMatch[2],
                            description: '',
                            date: '',
                            updateDate: '',
                            link: ''
                        };
                    }
                } else if (trimmed.startsWith('**èª¬æ˜:**')) {
                    if (currentApp) {
                        currentApp.description = trimmed.replace('**èª¬æ˜:**', '').trim();
                    }
                } else if (trimmed.startsWith('**åˆ¶ä½œæ—¥:**')) {
                    if (currentApp) {
                        currentApp.date = trimmed.replace('**åˆ¶ä½œæ—¥:**', '').trim();
                    }
                } else if (trimmed.startsWith('**æ›´æ–°æ—¥:**')) {
                    if (currentApp) {
                        currentApp.updateDate = trimmed.replace('**æ›´æ–°æ—¥:**', '').trim();
                    }
                } else if (trimmed.startsWith('**ãƒªãƒ³ã‚¯:**')) {
                    if (currentApp) {
                        // ãƒªãƒ³ã‚¯ã®æŠ½å‡ºã¯å°‘ã—ç·©ã‚ã«
                        const linkMatch = trimmed.match(/\[(.+?)\]\((.+?)\)/);
                        if (linkMatch) {
                            currentApp.link = linkMatch[2];
                        }
                    }
                }
            }

            if (currentApp) apps.push(currentApp);

            return apps;
        }

        function setupSearch() {
            const searchInput = document.getElementById('search-input');
            searchInput.addEventListener('input', (e) => {
                const query = e.target.value.toLowerCase();
                const filteredApps = allApps.filter(app => {
                    return app.title.toLowerCase().includes(query) ||
                        app.description.toLowerCase().includes(query);
                });
                renderApps(filteredApps);
            });
        }

        function getDateObject(dateString) {
            if (!dateString) return new Date(0); // éå»ã®æ—¥ä»˜
            const dateMatch = dateString.match(/(\d{4})å¹´(\d{1,2})æœˆ(\d{1,2})æ—¥/);
            if (!dateMatch) return new Date(0);

            const year = parseInt(dateMatch[1]);
            const month = parseInt(dateMatch[2]) - 1;
            const day = parseInt(dateMatch[3]);

            return new Date(year, month, day);
        }

        function isNewApp(dateString) {
            if (!dateString) return false;

            const appDate = getDateObject(dateString);
            const now = new Date();

            // 30æ—¥ä»¥å†…ãªã‚‰Newã¨ã™ã‚‹
            const diffTime = Math.abs(now - appDate);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

            return diffDays <= 30;
        }

        function renderApps(apps) {
            const appsGrid = document.getElementById('apps-grid');
            appsGrid.innerHTML = '';

            if (apps.length === 0) {
                appsGrid.innerHTML = '<p style="text-align:center; grid-column:1/-1; color:#718096;">è©²å½“ã™ã‚‹ã‚¢ãƒ—ãƒªãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚</p>';
                return;
            }

            apps.forEach((app, index) => {
                const appCard = document.createElement('div');
                appCard.className = 'app-card';
                // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã®é…å»¶ã‚’è¿½åŠ 
                appCard.style.animationDelay = `${index * 0.05}s`;

                // æ›´æ–°æ—¥ãŒã‚ã‚Œã°ãã‚Œã‚’å„ªå…ˆã—ã¦NEWåˆ¤å®š
                const checkDate = app.updateDate || app.date;
                const isNew = isNewApp(checkDate);
                const newBadge = isNew ? '<div class="badge-new">NEW</div>' : '';

                // ã‚µãƒ‹ã‚¿ã‚¤ã‚ºã•ã‚ŒãŸå€¤ã‚’ä½¿ç”¨
                const safeTitle = escapeHtml(app.title);
                const safeDesc = escapeHtml(app.description);
                const safeDate = escapeHtml(app.date);
                const safeUpdateDate = escapeHtml(app.updateDate);
                const safeLink = escapeHtml(app.link);
                // ã‚¢ã‚¤ã‚³ãƒ³ã¯çµµæ–‡å­—å‰æãªã®ã§ãã®ã¾ã¾å‡ºã™ãŒã€å¿µã®ãŸã‚ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã—ã¦ã‚‚è‰¯ã„ãŒçµµæ–‡å­—ãŒå£Šã‚Œã‚‹å ´åˆã‚‚ã‚ã‚‹ã®ã§æ³¨æ„
                // ã“ã“ã§ã¯çµµæ–‡å­—1æ–‡å­—+Î±ã¨æƒ³å®šã—ã¦ãã®ã¾ã¾å‡ºã™ï¼ˆMarkdownã®ãƒ‘ãƒ¼ã‚¹ã§æŠ½å‡ºã•ã‚ŒãŸã‚‚ã®ï¼‰
                const safeIcon = app.icon;

                let dateDisplay = `<div class="app-date">${safeDate}</div>`;
                if (safeUpdateDate) {
                    dateDisplay = `<div class="app-date">ğŸ”„ ${safeUpdateDate}</div>`;
                }

                appCard.innerHTML = `
                    ${newBadge}
                    <h3>
                        <span class="app-icon">${safeIcon}</span>
                        ${safeTitle}
                    </h3>
                    <p>${safeDesc}</p>
                    <div class="card-footer">
                        ${dateDisplay}
                        <a href="${safeLink}" class="app-link" target="_blank" rel="noopener noreferrer" aria-label="${safeTitle}ã‚’é–‹ã">
                            <i class="fas fa-arrow-right"></i>
                        </a>
                    </div>
                `;

                // ã‚«ãƒ¼ãƒ‰å…¨ä½“ã‚’ã‚¯ãƒªãƒƒã‚¯å¯èƒ½ã«ã™ã‚‹
                appCard.addEventListener('click', (e) => {
                    // ãƒªãƒ³ã‚¯ãƒœã‚¿ãƒ³ãã®ã‚‚ã®ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸå ´åˆã¯é‡è¤‡å‡¦ç†ã—ãªã„
                    if (e.target.closest('.app-link')) return;

                    // ãƒ†ã‚­ã‚¹ãƒˆé¸æŠä¸­ã¯é·ç§»ã—ãªã„ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ“ãƒªãƒ†ã‚£å‘ä¸Šï¼‰
                    const selection = window.getSelection();
                    if (selection.toString().length > 0) return;

                    window.open(safeLink, '_blank', 'noopener,noreferrer');
                });

                appsGrid.appendChild(appCard);
            });
        }

        function showError(message) {
            const appsGrid = document.getElementById('apps-grid');
            appsGrid.innerHTML = `
                <div class="error-message">
                    <h3><i class="fas fa-exclamation-triangle"></i> ã‚¨ãƒ©ãƒ¼</h3>
                    <p>${escapeHtml(message)}</p>
                </div>
            `;
        }

        document.addEventListener('DOMContentLoaded', () => {
            loadApps();

            // ã‚·ã‚§ã‚¢ãƒœã‚¿ãƒ³ã«ç¾åœ¨ã®URLã‚’è¿½åŠ 
            const shareBtn = document.querySelector('.share-button');
            if (shareBtn) {
                const currentUrl = encodeURIComponent(window.location.href);
                const currentHref = shareBtn.getAttribute('href');
                shareBtn.setAttribute('href', `${currentHref}%0a&url=${currentUrl}`);
            }
        });
    </script>
</body>

</html>