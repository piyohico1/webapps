<!DOCTYPE html>
<html lang="ja">
<head>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-MSTVN0KCF9"></script>
    <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-MSTVN0KCF9');
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é ­èº«åˆ¤å®šã‚¢ãƒ—ãƒª</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
        }

        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
            font-size: 2.5rem;
            background: linear-gradient(45deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .upload-area {
            border: 3px dashed #667eea;
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            margin-bottom: 30px;
            transition: all 0.3s ease;
            cursor: pointer;
            background: rgba(102, 126, 234, 0.05);
        }

        .upload-area:hover {
            border-color: #764ba2;
            background: rgba(118, 75, 162, 0.1);
            transform: translateY(-2px);
        }

        .upload-area.dragover {
            border-color: #764ba2;
            background: rgba(118, 75, 162, 0.2);
            transform: scale(1.02);
        }

        #fileInput {
            display: none;
        }

        .upload-text {
            font-size: 1.2rem;
            color: #666;
            margin-bottom: 10px;
        }

        .upload-hint {
            font-size: 0.9rem;
            color: #999;
        }

        .clipboard-notice {
            background: rgba(76, 175, 80, 0.1);
            color: #4caf50;
            padding: 10px;
            border-radius: 8px;
            margin-top: 10px;
            font-size: 0.9rem;
            text-align: center;
            border: 1px solid rgba(76, 175, 80, 0.3);
            display: none;
        }

        .analysis-container {
            display: none;
            grid-template-columns: 1fr 400px;
            gap: 30px;
            margin-top: 30px;
        }

        .image-section {
            position: relative;
            min-height: 400px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .image-container {
            width: 100%;
            max-width: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
            background: #f8f9fa;
            min-height: 400px;
        }

        #canvas {
            max-width: 100%;
            max-height: 80vh;
            border-radius: 10px;
            cursor: crosshair;
            object-fit: contain;
        }

        .controls {
            margin-top: 20px;
            text-align: center;
        }

        .results-section {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.05);
            height: fit-content;
            position: sticky;
            top: 20px;
        }

        .result-item {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            transition: transform 0.2s ease;
        }

        .result-item:hover {
            transform: translateY(-2px);
        }

        .result-label {
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
            font-size: 1.1rem;
        }

        .result-value {
            font-size: 1.5rem;
            color: #667eea;
            font-weight: bold;
        }

        .proportion-scale {
            background: linear-gradient(90deg, #ff6b6b 0%, #ffd93d 20%, #6bcf7f 40%, #4ecdc4 60%, #45b7d1 80%, #764ba2 100%);
            height: 20px;
            border-radius: 10px;
            margin: 15px 0;
            position: relative;
        }

        .scale-marker {
            position: absolute;
            top: -5px;
            width: 3px;
            height: 30px;
            background: #333;
            border-radius: 2px;
            transition: left 0.5s ease;
        }

        .btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1rem;
            margin: 0 10px;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
        }

        .instructions {
            background: rgba(102, 126, 234, 0.1);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 4px solid #667eea;
        }

        .error-message {
            background: rgba(255, 107, 107, 0.1);
            color: #ff6b6b;
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
            border-left: 4px solid #ff6b6b;
            display: none;
        }

        .measurement-info {
            font-size: 0.9rem;
            color: #666;
            margin-top: 10px;
            padding: 10px;
            background: rgba(102, 126, 234, 0.05);
            border-radius: 8px;
        }

        @media (max-width: 1200px) {
            .analysis-container {
                grid-template-columns: 1fr 350px;
            }
        }

        @media (max-width: 968px) {
            .analysis-container {
                grid-template-columns: 1fr;
            }
            
            .results-section {
                position: static;
                margin-top: 20px;
            }
        }

        @media (max-width: 768px) {
            h1 {
                font-size: 2rem;
            }
            
            .container {
                padding: 20px;
            }

            .analysis-container {
                gap: 20px;
            }

            .image-container {
                min-height: 300px;
            }

            #canvas {
                max-height: 60vh;
            }
        }

        @media (max-width: 480px) {
            .container {
                padding: 15px;
            }

            .btn {
                padding: 10px 20px;
                font-size: 0.9rem;
                margin: 5px;
            }

            .controls {
                display: flex;
                flex-direction: column;
                gap: 10px;
                align-items: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ“ é ­èº«åˆ¤å®šã‚¢ãƒ—ãƒª</h1>
        
        <div class="instructions">
            <strong>ä½¿ã„æ–¹ï¼š</strong>
            <ol style="margin-left: 20px; margin-top: 10px;">
                <li>äººç‰©ãŒå†™ã£ãŸç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼ˆãƒ•ã‚¡ã‚¤ãƒ«é¸æŠãƒ»D&Dãƒ»<strong>Ctrl+V</strong>ï¼‰</li>
                <li><strong>é ­ã®æ¸¬å®šï¼š</strong>é ­é ‚éƒ¨ã‚’ã‚¯ãƒªãƒƒã‚¯ï¼†ãƒ‰ãƒ©ãƒƒã‚°ã—ã¦é ­ã®å¤§ãã•ã‚’è¨­å®š</li>
                <li><strong>è¶³å…ƒã®æ¸¬å®šï¼š</strong>ãƒ‰ãƒ©ãƒƒã‚°å®Œäº†å¾Œã€è¶³å…ƒã‚’<span style="color: #4ecdc4; font-weight: bold;">ã‚·ãƒ³ã‚°ãƒ«ã‚¯ãƒªãƒƒã‚¯</span></li>
                <li>è‡ªå‹•ã§é ­èº«ãŒè¨ˆç®—ã•ã‚Œã€å®šè¦ã®åˆ†å‰²ç·šã‚‚è¡¨ç¤ºã•ã‚Œã¾ã™</li>
            </ol>
        </div>

        <div class="upload-area" id="uploadArea">
            <div class="upload-text">ğŸ“¸ ç”»åƒã‚’ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ— ã¾ãŸã¯ ã‚¯ãƒªãƒƒã‚¯ã—ã¦é¸æŠ</div>
            <div class="upload-hint">JPG, PNG, GIFå¯¾å¿œ | <strong>Ctrl+V</strong>ã§ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã‹ã‚‰è²¼ã‚Šä»˜ã‘</div>
            <input type="file" id="fileInput" accept="image/*">
        </div>

        <div class="error-message" id="errorMessage"></div>
        
        <div class="clipboard-notice" id="clipboardNotice">
            ğŸ“‹ ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã‹ã‚‰ç”»åƒã‚’è²¼ã‚Šä»˜ã‘ã¾ã—ãŸï¼
        </div>

        <div class="analysis-container" id="analysisContainer">
            <div class="image-section">
                <div class="image-container">
                    <canvas id="canvas"></canvas>
                </div>
                <div class="controls">
                    <button class="btn" onclick="resetPoints()">ğŸ”„ ãƒªã‚»ãƒƒãƒˆ</button>
                    <button class="btn" onclick="uploadNew()">ğŸ“ æ–°ã—ã„ç”»åƒ</button>
                </div>
            </div>
            
            <div class="results-section">
                <div class="result-item">
                    <div class="result-label">æ¸¬å®šçŠ¶æ³</div>
                    <div id="statusText" style="font-size: 1rem; color: #666;">
                        ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„
                    </div>
                </div>
                
                <div class="result-item">
                    <div class="result-label">æ¨å®šèº«é•·</div>
                    <div class="result-value" id="estimatedHeight">-</div>
                    <div class="measurement-info">
                        <div>é ­ã®å®Ÿå¯¸æ¨å®š: <span id="realHeadSize">-</span></div>
                        <div>èº«é•·è¨ˆç®—å¼: é ­ã®é«˜ã• Ã— é ­èº«</div>
                    </div>
                </div>
                
                <div class="result-item">
                    <div class="result-label">é ­èº«</div>
                    <div class="result-value" id="proportionResult">-</div>
                </div>
                
                <div class="result-item">
                    <div class="result-label">è©•ä¾¡</div>
                    <div class="result-value" id="evaluationResult">-</div>
                </div>
                
                <div class="result-item">
                    <div class="result-label">æ¸¬å®šãƒ‡ãƒ¼ã‚¿</div>
                    <div class="measurement-info">
                        <div>é ­ã®é«˜ã•: <span id="headHeight">-</span></div>
                        <div>å…¨èº«ã®é«˜ã•: <span id="totalHeight">-</span></div>
                        <div>ç”»åƒå†…æ¯”ç‡: <span id="ratio">-</span></div>
                    </div>
                </div>
                
                <div class="result-item">
                    <div class="result-label">é ­èº«ã‚¹ã‚±ãƒ¼ãƒ«</div>
                    <div class="proportion-scale">
                        <div class="scale-marker" id="scaleMarker"></div>
                    </div>
                    <div style="display: flex; justify-content: space-between; font-size: 0.8rem; color: #666; margin-top: 5px;">
                        <span>3é ­èº«</span>
                        <span>4é ­èº«</span>
                        <span>5é ­èº«</span>
                        <span>6é ­èº«</span>
                        <span>7é ­èº«</span>
                        <span>8é ­èº«</span>
                        <span>9é ­èº«</span>
                        <span>10é ­èº«</span>
                    </div>
                </div>
                
                <div class="result-item">
                    <div class="result-label">èº«é•·ç¯„å›²å‚è€ƒ</div>
                    <div class="measurement-info" id="heightRangeInfo">
                        <div>ä¸€èˆ¬çš„ãªèº«é•·ç¯„å›²ã§ã®é ­èº«æ¯”è¼ƒ</div>
                        <div id="heightComparison">-</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let canvas, ctx;
        let headTop = null;
        let headBottom = null;
        let footPoint = null;
        let imageLoaded = false;
        let currentImage = null;
        let isDragging = false;
        let dragStart = null;

        // åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', function() {
            canvas = document.getElementById('canvas');
            ctx = canvas.getContext('2d');
            
            setupEventListeners();
        });

        function setupEventListeners() {
            const uploadArea = document.getElementById('uploadArea');
            const fileInput = document.getElementById('fileInput');

            // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠ
            uploadArea.addEventListener('click', () => fileInput.click());
            fileInput.addEventListener('change', handleFileSelect);

            // ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—
            uploadArea.addEventListener('dragover', handleDragOver);
            uploadArea.addEventListener('dragleave', handleDragLeave);
            uploadArea.addEventListener('drop', handleDrop);

            // ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚¤ãƒ™ãƒ³ãƒˆ
            canvas.addEventListener('mousedown', handleMouseDown);
            canvas.addEventListener('mousemove', handleMouseMove);
            canvas.addEventListener('mouseup', handleMouseUp);
            canvas.addEventListener('click', handleCanvasClick);

            // ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰å¯¾å¿œ
            document.addEventListener('paste', handlePaste);
            document.addEventListener('keydown', handleKeyDown);
        }

        function handleDragOver(e) {
            e.preventDefault();
            document.getElementById('uploadArea').classList.add('dragover');
        }

        function handleDragLeave(e) {
            e.preventDefault();
            document.getElementById('uploadArea').classList.remove('dragover');
        }

        function handleDrop(e) {
            e.preventDefault();
            document.getElementById('uploadArea').classList.remove('dragover');
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                loadImage(files[0]);
            }
        }

        function handleFileSelect(e) {
            const file = e.target.files[0];
            if (file) {
                loadImage(file);
            }
        }

        function handlePaste(e) {
            e.preventDefault();
            
            const items = e.clipboardData.items;
            let imageFile = null;

            // ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã‚¢ã‚¤ãƒ†ãƒ ã‹ã‚‰ç”»åƒã‚’æ¢ã™
            for (let i = 0; i < items.length; i++) {
                const item = items[i];
                if (item.type.indexOf('image') !== -1) {
                    imageFile = item.getAsFile();
                    break;
                }
            }

            if (imageFile) {
                showClipboardNotice();
                loadImage(imageFile);
            } else {
                showError('ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ç”»åƒãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
            }
        }

        function handleKeyDown(e) {
            // Ctrl+V ã¾ãŸã¯ Cmd+V ã§ãƒšãƒ¼ã‚¹ãƒˆæ“ä½œã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆ
            if ((e.ctrlKey || e.metaKey) && e.key === 'v') {
                const uploadArea = document.getElementById('uploadArea');
                uploadArea.style.borderColor = '#4caf50';
                uploadArea.style.background = 'rgba(76, 175, 80, 0.1)';
                
                setTimeout(() => {
                    uploadArea.style.borderColor = '#667eea';
                    uploadArea.style.background = 'rgba(102, 126, 234, 0.05)';
                }, 200);
            }
        }

        function loadImage(file) {
            if (!file.type.startsWith('image/')) {
                showError('ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.onload = function() {
                    displayImage(img);
                    resetPoints();
                    hideError();
                    hideClipboardNotice();
                };
                img.src = e.target.result;
                currentImage = img;
            };
            reader.readAsDataURL(file);
        }

        function displayImage(img) {
            // ç”»åƒã‚³ãƒ³ãƒ†ãƒŠã®ã‚µã‚¤ã‚ºã‚’å–å¾—
            const container = document.querySelector('.image-container');
            const containerRect = container.getBoundingClientRect();
            const maxWidth = containerRect.width - 40; // ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã‚’è€ƒæ…®
            const maxHeight = Math.min(window.innerHeight * 0.8, 800); // ç”»é¢ã®80%ã¾ãŸã¯Max800px
            
            // æœ€å°ã‚µã‚¤ã‚ºã‚’è¨­å®šï¼ˆæ ã®50%ä»¥ä¸Šã¯ä½¿ç”¨ï¼‰
            const minWidth = maxWidth * 0.5;
            const minHeight = maxHeight * 0.5;
            
            let { width, height } = img;
            
            // ã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”ã‚’ä¿æŒã—ã¦ãƒªã‚µã‚¤ã‚º
            // ã¾ãšæœ€å¤§ã‚µã‚¤ã‚ºã«åˆ¶é™
            if (width > maxWidth || height > maxHeight) {
                const ratio = Math.min(maxWidth / width, maxHeight / height);
                width *= ratio;
                height *= ratio;
            }
            
            // ç”»åƒãŒå°ã•ã™ãã‚‹å ´åˆã¯æ‹¡å¤§ï¼ˆæœ€å°ã‚µã‚¤ã‚ºã¾ã§ï¼‰
            if (width < minWidth || height < minHeight) {
                const ratio = Math.max(minWidth / width, minHeight / height);
                width *= ratio;
                height *= ratio;
                
                // æ‹¡å¤§å¾Œã«æœ€å¤§ã‚µã‚¤ã‚ºã‚’è¶…ãˆãŸå ´åˆã¯å†èª¿æ•´
                if (width > maxWidth || height > maxHeight) {
                    const adjustRatio = Math.min(maxWidth / width, maxHeight / height);
                    width *= adjustRatio;
                    height *= adjustRatio;
                }
            }
            
            canvas.width = width;
            canvas.height = height;
            
            // ç”»åƒã‚’æç”»
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.drawImage(img, 0, 0, width, height);
            
            imageLoaded = true;
            document.getElementById('analysisContainer').style.display = 'grid';
            
            updateStatus('é ­é ‚éƒ¨ã‚’ã‚¯ãƒªãƒƒã‚¯ï¼†ãƒ‰ãƒ©ãƒƒã‚°ã—ã¦é ­ã®å¤§ãã•ã‚’è¨­å®šã—ã¦ãã ã•ã„');
        }

        function getCanvasCoordinates(e) {
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            // ã‚­ãƒ£ãƒ³ãƒã‚¹ã®ã‚¹ã‚±ãƒ¼ãƒ«ã‚’è€ƒæ…®
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            return {
                x: x * scaleX,
                y: y * scaleY
            };
        }

        function handleMouseDown(e) {
            if (!imageLoaded) return;

            const coords = getCanvasCoordinates(e);
            
            if (!headTop) {
                isDragging = true;
                dragStart = coords;
                headTop = coords;
                e.preventDefault();
            }
        }

        function handleMouseMove(e) {
            if (!isDragging || !headTop) return;

            const coords = getCanvasCoordinates(e);
            headBottom = coords;
            
            redrawCanvas();
            e.preventDefault();
        }

        function handleMouseUp(e) {
            if (isDragging && headTop && headBottom) {
                isDragging = false;
                updateStatus('è¶³å…ƒã‚’ã‚·ãƒ³ã‚°ãƒ«ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„');
                redrawCanvas();
                e.preventDefault();
                return;
            }
            
            // é ­ã®è¨­å®šãŒå®Œäº†ã—ã¦ã„ã‚‹å ´åˆã¯è¶³å…ƒã‚’è¨­å®š
            if (!isDragging && headTop && headBottom && !footPoint) {
                const coords = getCanvasCoordinates(e);
                footPoint = coords;
                updateStatus('æ¸¬å®šå®Œäº†ï¼');
                redrawCanvas();
                calculateProportion();
                e.preventDefault();
            }
        }

        function handleCanvasClick(e) {
            // ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã¯ç„¡åŠ¹åŒ–ï¼ˆmouseupã§å‡¦ç†ï¼‰
            e.preventDefault();
        }

        function redrawCanvas() {
            if (!currentImage) return;

            // ç”»åƒã‚’å†æç”»
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.drawImage(currentImage, 0, 0, canvas.width, canvas.height);

            // é ­ã®ç¯„å›²ã‚’æç”»
            if (headTop && headBottom) {
                drawHeadRange(headTop, headBottom);
            }

            // è¶³å…ƒãƒã‚¤ãƒ³ãƒˆã‚’æç”»
            if (footPoint) {
                drawPoint(footPoint.x, footPoint.y, '#4ecdc4', 'è¶³');
            }

            // å®šè¦ã¨åˆ†å‰²ç·šã‚’æç”»
            if (headTop && headBottom && footPoint) {
                drawRulerWithDivisions();
            }
        }

        function drawHeadRange(top, bottom) {
            // é ­ã®ç¯„å›²ã‚’çŸ©å½¢ã§è¡¨ç¤º
            const headHeight = Math.abs(bottom.y - top.y);
            const headWidth = headHeight * 0.8; // é ­ã®å¹…ã¯é«˜ã•ã®80%ç¨‹åº¦
            const centerX = (top.x + bottom.x) / 2;
            const minY = Math.min(top.y, bottom.y);

            // é ­ã®ç¯„å›²ã®èƒŒæ™¯
            ctx.fillStyle = 'rgba(255, 107, 107, 0.2)';
            ctx.fillRect(centerX - headWidth/2, minY, headWidth, headHeight);

            // é ­ã®ç¯„å›²ã®æ ç·š
            ctx.strokeStyle = '#ff6b6b';
            ctx.lineWidth = 2;
            ctx.strokeRect(centerX - headWidth/2, minY, headWidth, headHeight);

            // é ­é ‚éƒ¨ã¨é ­ã®ä¸‹ç«¯ã®ãƒã‚¤ãƒ³ãƒˆ
            drawPoint(centerX, minY, '#ff6b6b', 'é ­é ‚');
            drawPoint(centerX, minY + headHeight, '#ff6b6b', 'é¡');

            // é ­ã®é«˜ã•ã‚’è¡¨ç¤º
            ctx.fillStyle = '#ff6b6b';
            ctx.font = 'bold 12px Arial';
            ctx.textAlign = 'left';
            ctx.fillText(`é ­ã®é«˜ã•: ${Math.round(headHeight)}px`, centerX + headWidth/2 + 10, minY + headHeight/2);
        }

        function drawPoint(x, y, color, label) {
            // å¤–å´ã®å††
            ctx.beginPath();
            ctx.arc(x, y, 12, 0, 2 * Math.PI);
            ctx.fillStyle = color;
            ctx.fill();
            ctx.strokeStyle = 'white';
            ctx.lineWidth = 3;
            ctx.stroke();

            // å†…å´ã®å††
            ctx.beginPath();
            ctx.arc(x, y, 6, 0, 2 * Math.PI);
            ctx.fillStyle = 'white';
            ctx.fill();

            // ãƒ©ãƒ™ãƒ«
            ctx.fillStyle = color;
            ctx.font = 'bold 14px Arial';
            ctx.textAlign = 'center';
            ctx.fillText(label, x, y - 20);
        }

        function drawRulerWithDivisions() {
            if (!headTop || !headBottom || !footPoint) return;

            const headHeight = Math.abs(headBottom.y - headTop.y);
            const totalHeight = Math.abs(footPoint.y - Math.min(headTop.y, headBottom.y));
            const proportion = totalHeight / headHeight;
            
            const startY = Math.min(headTop.y, headBottom.y);
            const endY = footPoint.y;
            const rulerX = Math.max(headTop.x, headBottom.x, footPoint.x) + 50;

            // å®šè¦ã®ç¸¦ç·š
            ctx.beginPath();
            ctx.moveTo(rulerX, startY);
            ctx.lineTo(rulerX, endY);
            ctx.strokeStyle = '#333';
            ctx.lineWidth = 3;
            ctx.stroke();

            // é ­èº«åˆ†å‰²ç·šã‚’æç”»
            const divisions = Math.ceil(proportion);
            for (let i = 0; i <= divisions; i++) {
                const y = startY + (headHeight * i);
                if (y <= endY) {
                    // åˆ†å‰²ç·š
                    ctx.beginPath();
                    ctx.moveTo(rulerX - 15, y);
                    ctx.lineTo(rulerX + 15, y);
                    ctx.strokeStyle = i === 0 ? '#ff6b6b' : '#667eea';
                    ctx.lineWidth = i === 0 ? 3 : 2;
                    ctx.stroke();

                    // é ­èº«ç•ªå·
                    ctx.fillStyle = '#333';
                    ctx.font = 'bold 14px Arial';
                    ctx.textAlign = 'left';
                    ctx.fillText(`${i}`, rulerX + 20, y + 5);

                    // å®Ÿéš›ã®æ¸¬å®šå€¤è¡¨ç¤ºï¼ˆ1é ­èº«ç›®ã®ã¿ï¼‰
                    if (i === 1) {
                        ctx.fillStyle = '#666';
                        ctx.font = '12px Arial';
                        ctx.fillText(`${Math.round(headHeight)}px`, rulerX + 40, y + 5);
                    }
                }
            }

            // æœ€ä¸‹ç«¯ã®ç·šï¼ˆè¶³å…ƒï¼‰
            if (endY > startY + (headHeight * divisions)) {
                ctx.beginPath();
                ctx.moveTo(rulerX - 15, endY);
                ctx.lineTo(rulerX + 15, endY);
                ctx.strokeStyle = '#4ecdc4';
                ctx.lineWidth = 3;
                ctx.stroke();

                const finalProportion = (endY - startY) / headHeight;
                ctx.fillStyle = '#333';
                ctx.font = 'bold 14px Arial';
                ctx.textAlign = 'left';
                ctx.fillText(`${finalProportion.toFixed(1)}`, rulerX + 20, endY + 5);
            }

            // å®šè¦ã®ãƒ©ãƒ™ãƒ«
            ctx.fillStyle = '#333';
            ctx.font = 'bold 16px Arial';
            ctx.textAlign = 'center';
            ctx.save();
            ctx.translate(rulerX - 30, (startY + endY) / 2);
            ctx.rotate(-Math.PI / 2);
            ctx.fillText('é ­èº«å®šè¦', 0, 0);
            ctx.restore();
        }

        function calculateProportion() {
            if (!headTop || !headBottom || !footPoint) return;

            const headHeight = Math.abs(headBottom.y - headTop.y);
            const totalHeight = Math.abs(footPoint.y - Math.min(headTop.y, headBottom.y));
            const proportion = totalHeight / headHeight;

            const roundedProportion = Math.round(proportion * 10) / 10;
            
            document.getElementById('proportionResult').textContent = `${roundedProportion}é ­èº«`;
            
            // æ¨å®šèº«é•·ã‚’è¨ˆç®—
            const estimatedHeight = calculateEstimatedHeight(headHeight, proportion);
            document.getElementById('estimatedHeight').textContent = estimatedHeight.height;
            document.getElementById('realHeadSize').textContent = estimatedHeight.headSize;
            
            // æ¸¬å®šãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°
            document.getElementById('headHeight').textContent = `${Math.round(headHeight)}px`;
            document.getElementById('totalHeight').textContent = `${Math.round(totalHeight)}px`;
            document.getElementById('ratio').textContent = `1:${roundedProportion}`;
            
            // èº«é•·ç¯„å›²æ¯”è¼ƒã‚’è¡¨ç¤º
            displayHeightComparison(proportion);
            
            // è©•ä¾¡ã‚’è¨­å®š
            let evaluation = '';
            if (proportion < 4) {
                evaluation = 'ãƒ‡ãƒ•ã‚©ãƒ«ãƒ¡å¼·';
            } else if (proportion < 5) {
                evaluation = 'ã¡ã³ã‚­ãƒ£ãƒ©é¢¨';
            } else if (proportion < 6) {
                evaluation = 'å­ä¾›ã‚‰ã—ã„';
            } else if (proportion < 6.5) {
                evaluation = 'å¯æ„›ã‚‰ã—ã„';
            } else if (proportion < 7.5) {
                evaluation = 'ãƒãƒ©ãƒ³ã‚¹è‰¯å¥½';
            } else if (proportion < 8.5) {
                evaluation = 'ã‚¹ã‚¿ã‚¤ãƒ«è‰¯å¥½';
            } else if (proportion < 9.5) {
                evaluation = 'ãƒ¢ãƒ‡ãƒ«ä½“å‹';
            } else {
                evaluation = 'è¶…ã‚¹ã‚¿ã‚¤ãƒ«æŠœç¾¤';
            }
            
            document.getElementById('evaluationResult').textContent = evaluation;
            
            // ã‚¹ã‚±ãƒ¼ãƒ«ãƒãƒ¼ã‚«ãƒ¼ã‚’æ›´æ–°
            updateScaleMarker(proportion);
        }

        function calculateEstimatedHeight(headHeightPx, proportion) {
            // å¹³å‡çš„ãªé ­ã®å®Ÿå¯¸ï¼ˆæˆäººï¼‰
            const averageHeadSizes = {
                male: 23.5,   // cmï¼ˆç”·æ€§å¹³å‡ï¼‰
                female: 22.0, // cmï¼ˆå¥³æ€§å¹³å‡ï¼‰
                child: 20.0,  // cmï¼ˆå­ä¾›å¹³å‡ï¼‰
                average: 22.5 // cmï¼ˆå…¨ä½“å¹³å‡ï¼‰
            };

            // é ­èº«ã‹ã‚‰æ¨å®šã•ã‚Œã‚‹äººç‰©ã‚¿ã‚¤ãƒ—
            let headSizeCm;
            let personType;
            
            if (proportion < 4) {
                headSizeCm = 18.0;  // æ¥µç«¯ã«ãƒ‡ãƒ•ã‚©ãƒ«ãƒ¡ã•ã‚ŒãŸã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼
                personType = "ãƒ‡ãƒ•ã‚©ãƒ«ãƒ¡ã‚­ãƒ£ãƒ©";
            } else if (proportion < 5) {
                headSizeCm = averageHeadSizes.child;
                personType = "ã¡ã³ã‚­ãƒ£ãƒ©";
            } else if (proportion < 6) {
                headSizeCm = averageHeadSizes.child;
                personType = "å­ä¾›ãƒ»ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼";
            } else if (proportion < 7) {
                headSizeCm = averageHeadSizes.average;
                personType = "ä¸€èˆ¬çš„";
            } else if (proportion < 8) {
                headSizeCm = averageHeadSizes.average;
                personType = "ä¸€èˆ¬çš„";
            } else if (proportion < 9) {
                headSizeCm = averageHeadSizes.average;
                personType = "ã‚¹ã‚¿ã‚¤ãƒ«è‰¯å¥½";
            } else {
                headSizeCm = averageHeadSizes.average;
                personType = "ãƒ¢ãƒ‡ãƒ«ç´š";
            }

            // æ¨å®šèº«é•·ã‚’è¨ˆç®—ï¼ˆcmï¼‰
            const estimatedHeightCm = headSizeCm * proportion;
            
            // è¤‡æ•°ãƒ‘ã‚¿ãƒ¼ãƒ³ã§è¨ˆç®—
            const maleHeight = averageHeadSizes.male * proportion;
            const femaleHeight = averageHeadSizes.female * proportion;
            
            return {
                height: `${Math.round(estimatedHeightCm)}cmï¼ˆ${personType}ï¼‰`,
                headSize: `ç´„${headSizeCm}cm`,
                maleHeight: Math.round(maleHeight),
                femaleHeight: Math.round(femaleHeight)
            };
        }

        function displayHeightComparison(proportion) {
            const heights = {
                90: 90 / 22.5,    // 90cm ã®å ´åˆã®é ­èº«ï¼ˆå­ä¾›ï¼‰
                100: 100 / 22.5,  // 100cm ã®å ´åˆã®é ­èº«
                120: 120 / 22.5,  // 120cm ã®å ´åˆã®é ­èº«
                140: 140 / 22.5,  // 140cm ã®å ´åˆã®é ­èº«
                150: 150 / 22.5,  // 150cm ã®å ´åˆã®é ­èº«
                160: 160 / 22.5,  // 160cm ã®å ´åˆã®é ­èº«
                170: 170 / 22.5,  // 170cm ã®å ´åˆã®é ­èº«
                180: 180 / 22.5   // 180cm ã®å ´åˆã®é ­èº«
            };

            let comparisonText = '';
            
            // ç¾åœ¨ã®é ­èº«ã«æœ€ã‚‚è¿‘ã„èº«é•·ã‚’è¦‹ã¤ã‘ã‚‹
            let closestHeight = 160;
            let minDiff = Math.abs(proportion - heights[160]);
            
            for (const [height, headProp] of Object.entries(heights)) {
                const diff = Math.abs(proportion - headProp);
                if (diff < minDiff) {
                    minDiff = diff;
                    closestHeight = parseInt(height);
                }
            }

            comparisonText = `
                <div style="margin-top: 8px; display: grid; grid-template-columns: 1fr 1fr; gap: 4px; font-size: 0.9rem;">
                    <div>90cm â†’ ${heights[90].toFixed(1)}é ­èº«</div>
                    <div>100cm â†’ ${heights[100].toFixed(1)}é ­èº«</div>
                    <div>120cm â†’ ${heights[120].toFixed(1)}é ­èº«</div>
                    <div>140cm â†’ ${heights[140].toFixed(1)}é ­èº«</div>
                    <div>150cm â†’ ${heights[150].toFixed(1)}é ­èº«</div>
                    <div>160cm â†’ ${heights[160].toFixed(1)}é ­èº«</div>
                    <div>170cm â†’ ${heights[170].toFixed(1)}é ­èº«</div>
                    <div>180cm â†’ ${heights[180].toFixed(1)}é ­èº«</div>
                </div>
                <div style="margin-top: 10px; padding: 8px; background: rgba(102, 126, 234, 0.1); border-radius: 5px;">
                    <strong>æœ€ã‚‚è¿‘ã„æ¨™æº–èº«é•·: ${closestHeight}cm</strong>
                </div>
            `;
            
            document.getElementById('heightComparison').innerHTML = comparisonText;
        }

        function updateScaleMarker(proportion) {
            const marker = document.getElementById('scaleMarker');
            const minProp = 3;   // 3é ­èº«ã‹ã‚‰
            const maxProp = 10;  // 10é ­èº«ã¾ã§
            const clampedProp = Math.max(minProp, Math.min(maxProp, proportion));
            const percentage = ((clampedProp - minProp) / (maxProp - minProp)) * 100;
            
            marker.style.left = `${percentage}%`;
        }

        function resetPoints() {
            headTop = null;
            headBottom = null;
            footPoint = null;
            isDragging = false;
            dragStart = null;
            
            if (currentImage) {
                redrawCanvas();
                updateStatus('é ­é ‚éƒ¨ã‚’ã‚¯ãƒªãƒƒã‚¯ï¼†ãƒ‰ãƒ©ãƒƒã‚°ã—ã¦é ­ã®å¤§ãã•ã‚’è¨­å®šã—ã¦ãã ã•ã„');
            }
            
            document.getElementById('proportionResult').textContent = '-';
            document.getElementById('estimatedHeight').textContent = '-';
            document.getElementById('realHeadSize').textContent = '-';
            document.getElementById('evaluationResult').textContent = '-';
            document.getElementById('headHeight').textContent = '-';
            document.getElementById('totalHeight').textContent = '-';
            document.getElementById('ratio').textContent = '-';
            document.getElementById('heightComparison').innerHTML = '-';
            document.getElementById('scaleMarker').style.left = '50%';  // 6.5é ­èº«ã‚ãŸã‚Šï¼ˆ3-10é ­èº«ã®ä¸­å¤®ï¼‰
        }

        function uploadNew() {
            document.getElementById('analysisContainer').style.display = 'none';
            document.getElementById('fileInput').value = '';
            resetPoints();
            imageLoaded = false;
            currentImage = null;
            updateStatus('ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„');
        }

        function updateStatus(message) {
            const statusElement = document.getElementById('statusText');
            
            // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«å¿œã˜ã¦è‰²ã‚’è¨­å®š
            if (message.includes('é ­é ‚éƒ¨')) {
                statusElement.innerHTML = '<span style="color: #ff6b6b; font-weight: bold;">é ­é ‚éƒ¨ã‚’ã‚¯ãƒªãƒƒã‚¯ï¼†ãƒ‰ãƒ©ãƒƒã‚°ã—ã¦é ­ã®å¤§ãã•ã‚’è¨­å®šã—ã¦ãã ã•ã„</span>';
            } else if (message.includes('è¶³å…ƒ')) {
                statusElement.innerHTML = '<span style="color: #4ecdc4; font-weight: bold;">è¶³å…ƒã‚’ã‚·ãƒ³ã‚°ãƒ«ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„</span>';
            } else if (message.includes('æ¸¬å®šå®Œäº†')) {
                statusElement.innerHTML = '<span style="color: #6bcf7f; font-weight: bold;">æ¸¬å®šå®Œäº†ï¼</span>';
            } else {
                statusElement.innerHTML = message;
            }
        }

        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }

        function hideError() {
            document.getElementById('errorMessage').style.display = 'none';
        }

        function showClipboardNotice() {
            const notice = document.getElementById('clipboardNotice');
            notice.style.display = 'block';
            
            // 3ç§’å¾Œã«è‡ªå‹•ã§éè¡¨ç¤º
            setTimeout(() => {
                hideClipboardNotice();
            }, 3000);
        }

        function hideClipboardNotice() {
            document.getElementById('clipboardNotice').style.display = 'none';
        }
    </script>
</body>
</html>