<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Á∞°ÂçòÁîªÂÉèÂêàÊàê„ÉÑ„Éº„É´</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            margin: 0;
            font-size: 2.5em;
            font-weight: 300;
        }

        .content {
            padding: 30px;
        }

        .upload-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .upload-box {
            border: 3px dashed #ddd;
            border-radius: 15px;
            padding: 40px 20px;
            text-align: center;
            background: #fafafa;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            height: 200px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .upload-box:hover {
            border-color: #4facfe;
            background: #f0f8ff;
            transform: translateY(-5px);
        }

        .upload-box.dragover {
            border-color: #4facfe;
            background: #e6f3ff;
        }

        .upload-box h3 {
            margin-top: 0;
            color: #666;
            font-size: 1.3em;
        }

        .upload-box input[type="file"] {
            display: none;
        }

        .upload-icon {
            font-size: 3em;
            margin-bottom: 15px;
            color: #4facfe;
        }

        .preview-image {
            max-width: 100%;
            max-height: 80px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            margin-top: 10px;
        }

        .clear-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #ff4757;
            color: white;
            border: none;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 18px;
            display: none;
        }

        .workspace {
            display: grid;
            grid-template-columns: 1fr 300px;
            gap: 30px;
            margin-bottom: 30px;
        }

        .canvas-container {
            position: relative;
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            text-align: center;
        }

        .main-canvas {
            width: 100%;
            height: auto;
            max-height: 900px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            cursor: grab;
            object-fit: contain;
        }

        .main-canvas.eraser-mode {
            cursor: crosshair;
        }

        .main-canvas:active {
            cursor: grabbing;
        }

        .controls {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 15px;
            height: fit-content;
        }

        .controls h3 {
            margin-top: 0;
            color: #555;
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
        }

        .control-section {
            background: white;
            border: 2px solid #eee;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .control-section.collapsed {
            padding: 0;
        }

        .control-section h3 {
            margin-top: 0;
            margin-bottom: 15px;
            color: #4facfe;
            font-size: 1.1em;
            border-bottom: 2px solid #e8f4f8;
            padding-bottom: 8px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            user-select: none;
        }

        .control-section.collapsed h3 {
            margin-bottom: 0;
            border-bottom: none;
            padding: 15px 20px;
        }

        .toggle-icon {
            font-size: 1.2em;
            transition: transform 0.3s ease;
        }

        .control-section.collapsed .toggle-icon {
            transform: rotate(-90deg);
        }

        .control-content {
            transition: all 0.3s ease;
            overflow: hidden;
        }

        .control-section.collapsed .control-content {
            max-height: 0;
            opacity: 0;
            padding: 0 20px;
        }

        .control-group {
            margin-bottom: 20px;
        }

        .control-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #555;
            font-size: 0.9em;
        }

        .control-row {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .control-row input[type="range"] {
            flex: 1;
            height: 6px;
            background: #ddd;
            border-radius: 3px;
            outline: none;
            -webkit-appearance: none;
        }

        .control-row input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            background: #4facfe;
            border-radius: 50%;
            cursor: pointer;
        }

        .control-row input[type="number"] {
            width: 50px;
            padding: 5px;
            border: 2px solid #ddd;
            border-radius: 5px;
            text-align: center;
            font-size: 0.9em;
        }

        .control-row span {
            color: #666;
            font-size: 0.8em;
            min-width: 20px;
        }

        .instruction {
            background: #e8f4f8;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 4px solid #4facfe;
        }

        .instruction h4 {
            margin-top: 0;
            color: #2c5282;
        }

        .instruction p {
            margin: 5px 0;
            color: #2d3748;
            font-size: 0.9em;
        }

        .download-section {
            text-align: center;
            background: #f8f9fa;
            padding: 30px;
            border-radius: 15px;
        }

        .download-btn {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(79, 172, 254, 0.3);
        }

        .download-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(79, 172, 254, 0.4);
        }

        .download-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .reset-btn {
            background: #ff6b6b;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 0.9em;
            cursor: pointer;
            margin-left: 10px;
        }

        @media (max-width: 768px) {
            .upload-section {
                grid-template-columns: 1fr;
            }
            
            .workspace {
                grid-template-columns: 1fr;
            }
            
            .controls {
                order: -1;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Á∞°ÂçòÁîªÂÉèÂêàÊàê„ÉÑ„Éº„É´</h1>
            <p>„Éâ„É©„ÉÉ„Ç∞Êìç‰Ωú„ÅßÁ∞°Âçò„Å´‰ΩçÁΩÆË™øÊï¥„Åß„Åç„ÇãÂêàÊàê„ÉÑ„Éº„É´</p>
        </div>

        <div class="content">
            <div class="upload-section">
                <div class="upload-box" onclick="document.getElementById('backgroundInput').click()">
                    <div class="upload-icon">üñºÔ∏è</div>
                    <h3>ËÉåÊôØÁîªÂÉè</h3>
                    <p>„ÇØ„É™„ÉÉ„ÇØ„Åæ„Åü„ÅØ„Éâ„É©„ÉÉ„Ç∞&„Éâ„É≠„ÉÉ„Éó</p>
                    <input type="file" id="backgroundInput" accept="image/*">
                    <button class="clear-btn" id="clearBackground" onclick="event.stopPropagation(); clearBackground()">√ó</button>
                    <img id="backgroundPreview" class="preview-image" style="display: none;">
                </div>

                <div class="upload-box" onclick="document.getElementById('overlayInput').click()">
                    <div class="upload-icon">üé®</div>
                    <h3>ÂêàÊàêÁîªÂÉè</h3>
                    <p>„ÇØ„É™„ÉÉ„ÇØ„Åæ„Åü„ÅØ„Éâ„É©„ÉÉ„Ç∞&„Éâ„É≠„ÉÉ„Éó</p>
                    <input type="file" id="overlayInput" accept="image/*">
                    <button class="clear-btn" id="clearOverlay" onclick="event.stopPropagation(); clearOverlay()">√ó</button>
                    <img id="overlayPreview" class="preview-image" style="display: none;">
                </div>
            </div>

            <div class="workspace">
                <div class="canvas-container">
                    <canvas id="mainCanvas" class="main-canvas" style="display: none;"></canvas>
                    <div id="canvasPlaceholder">
                        <h3>ÂêàÊàêÁµêÊûú</h3>
                        <p>‰∏°Êñπ„ÅÆÁîªÂÉè„Çí„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ„Åô„Çã„Å®Ë°®Á§∫„Åï„Çå„Åæ„Åô</p>
                    </div>
                </div>

                <div class="controls">
                    <div class="instruction">
                        <h4>üí° Êìç‰ΩúÊñπÊ≥ï</h4>
                        <p>‚Ä¢ ÂêàÊàêÁîªÂÉè„Çí„Éâ„É©„ÉÉ„Ç∞„Åó„Å¶‰ΩçÁΩÆË™øÊï¥</p>
                        <p>‚Ä¢ „Éû„Ç¶„Çπ„Éõ„Ç§„Éº„É´„Åß„Çµ„Ç§„Ç∫Ë™øÊï¥</p>
                        <p>‚Ä¢ Shift„Ç≠„Éº + „Éâ„É©„ÉÉ„Ç∞„ÅßÂõûËª¢</p>
                        <p>‚Ä¢ „ÉÅ„Çß„ÉÉ„ÇØ„Éú„ÉÉ„ÇØ„Çπ„ÅßÂ∑¶Âè≥ÂèçËª¢</p>
                        <p>‚Ä¢ Ê∂à„Åó„Ç¥„É†„É¢„Éº„Éâ„Åß‰∏çË¶ÅÈÉ®ÂàÜ„ÇíÊ∂àÂéª</p>
                        <p>‚Ä¢ „Éö„É≥„Éª„Çø„ÉÉ„ÉÅÊìç‰Ωú„Å´ÂØæÂøú</p>
                        <p>‚Ä¢ „Çπ„É©„Ç§„ÉÄ„Éº„ÅßËâ≤Ë™ø„ÉªÊòéÂ∫¶Ë™øÊï¥</p>
                    </div>

                    <div class="control-section" id="positionSection">
                        <h3 onclick="toggleSection('positionSection')">
                            üéØ ‰ΩçÁΩÆ„ÉªÂ§âÂΩ¢
                            <span class="toggle-icon">‚ñº</span>
                        </h3>
                        
                        <div class="control-content">
                            <div class="control-group">
                                <label>„Çµ„Ç§„Ç∫</label>
                                <div class="control-row">
                                    <input type="range" id="scaleSlider" min="10" max="300" value="100">
                                    <input type="number" id="scaleInput" min="10" max="300" value="100">
                                    <span>%</span>
                                </div>
                            </div>

                            <div class="control-group">
                                <label>ÂõûËª¢</label>
                                <div class="control-row">
                                    <input type="range" id="rotationSlider" min="-180" max="180" value="0">
                                    <input type="number" id="rotationInput" min="-180" max="180" value="0">
                                    <span>¬∞</span>
                                </div>
                            </div>

                            <div class="control-group">
                                <label>ÈÄèÊòéÂ∫¶</label>
                                <div class="control-row">
                                    <input type="range" id="opacitySlider" min="0" max="100" value="100">
                                    <input type="number" id="opacityInput" min="0" max="100" value="100">
                                    <span>%</span>
                                </div>
                            </div>

                            <div class="control-group">
                                <label>Â∑¶Âè≥ÂèçËª¢</label>
                                <div class="control-row">
                                    <input type="checkbox" id="flipHorizontal" style="width: auto; margin-right: 10px;">
                                    <span>Ê∞¥Âπ≥ÂèçËª¢</span>
                                </div>
                            </div>

                            <div class="control-group">
                                <label>Ê∂à„Åó„Ç¥„É†„É¢„Éº„Éâ</label>
                                <div class="control-row">
                                    <input type="checkbox" id="eraserMode" style="width: auto; margin-right: 10px;">
                                    <span>Ê∂àÂéª„É¢„Éº„Éâ</span>
                                </div>
                            </div>

                            <div class="control-group" id="eraserSizeGroup" style="display: none;">
                                <label>Ê∂à„Åó„Ç¥„É†„Çµ„Ç§„Ç∫</label>
                                <div class="control-row">
                                    <input type="range" id="eraserSizeSlider" min="5" max="100" value="20">
                                    <input type="number" id="eraserSizeInput" min="5" max="100" value="20">
                                    <span>px</span>
                                </div>
                            </div>

                            <button class="reset-btn" onclick="resetPosition()">‰ΩçÁΩÆ„É™„Çª„ÉÉ„Éà</button>
                            <button class="reset-btn" onclick="resetEraser()" id="resetEraserBtn" style="display: none;">Ê∂àÂéª„É™„Çª„ÉÉ„Éà</button>
                        </div>
                    </div>

                    <div class="control-section" id="colorSection">
                        <h3 onclick="toggleSection('colorSection')">
                            üé® Ëâ≤Ë™øË™øÊï¥
                            <span class="toggle-icon">‚ñº</span>
                        </h3>
                        
                        <div class="control-content">
                            <div class="control-group">
                                <label>ÊòéÂ∫¶</label>
                                <div class="control-row">
                                    <input type="range" id="brightnessSlider" min="0" max="200" value="100">
                                    <input type="number" id="brightnessInput" min="0" max="200" value="100">
                                    <span>%</span>
                                </div>
                            </div>

                            <div class="control-group">
                                <label>„Ç≥„É≥„Éà„É©„Çπ„Éà</label>
                                <div class="control-row">
                                    <input type="range" id="contrastSlider" min="0" max="200" value="100">
                                    <input type="number" id="contrastInput" min="0" max="200" value="100">
                                    <span>%</span>
                                </div>
                            </div>

                            <div class="control-group">
                                <label>ÂΩ©Â∫¶</label>
                                <div class="control-row">
                                    <input type="range" id="saturationSlider" min="0" max="200" value="100">
                                    <input type="number" id="saturationInput" min="0" max="200" value="100">
                                    <span>%</span>
                                </div>
                            </div>

                            <div class="control-group">
                                <label>Ëâ≤Áõ∏</label>
                                <div class="control-row">
                                    <input type="range" id="hueSlider" min="-180" max="180" value="0">
                                    <input type="number" id="hueInput" min="-180" max="180" value="0">
                                    <span>¬∞</span>
                                </div>
                            </div>

                            <button class="reset-btn" onclick="resetColors()">Ëâ≤Ë™ø„É™„Çª„ÉÉ„Éà</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="download-section">
                <button id="downloadBtn" class="download-btn" disabled>ÁîªÂÉè„Çí„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ</button>
            </div>
        </div>
    </div>

    <script>
        let backgroundImage = null;
        let overlayImage = null;
        let canvas = null;
        let ctx = null;
        
        // ÈÄèÈÅéÁîªÂÉè„ÅÆÁä∂ÊÖã
        let overlayState = {
            x: 0,
            y: 0,
            scale: 1,
            rotation: 0,
            opacity: 1,
            brightness: 1,
            contrast: 1,
            saturation: 1,
            hue: 0,
            flipHorizontal: false,
            isDragging: false,
            isRotating: false,
            dragStartX: 0,
            dragStartY: 0,
            initialX: 0,
            initialY: 0
        };

        // Ê∂à„Åó„Ç¥„É†Èñ¢ÈÄ£
        let eraserState = {
            isActive: false,
            size: 20,
            isErasing: false,
            lastX: 0,
            lastY: 0,
            pressure: 1.0 // „Éö„É≥ÂúßÂäõÂØæÂøú
        };

        // ÂêàÊàêÁîªÂÉè„ÅÆ„Éû„Çπ„ÇØ„Ç≠„É£„É≥„Éê„ÇπÔºàÊ∂àÂéªÈÉ®ÂàÜ„ÇíË®òÈå≤Ôºâ
        let maskCanvas = null;
        let maskCtx = null;

        // ÂàùÊúüÂåñ
        function init() {
            canvas = document.getElementById('mainCanvas');
            ctx = canvas.getContext('2d');
            
            setupEventListeners();
        }

        // „Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº„ÅÆË®≠ÂÆö
        function setupEventListeners() {
            // „Éï„Ç°„Ç§„É´ÂÖ•Âäõ
            document.getElementById('backgroundInput').addEventListener('change', handleBackgroundUpload);
            document.getElementById('overlayInput').addEventListener('change', handleOverlayUpload);

            // „Éâ„É©„ÉÉ„Ç∞&„Éâ„É≠„ÉÉ„Éó
            setupDragAndDrop();

            // „Ç≥„É≥„Éà„É≠„Éº„É´
            setupControls();

            // „Ç≠„É£„É≥„Éê„Çπ„ÅÆ„Ç§„É≥„Çø„É©„ÇØ„Ç∑„Éß„É≥
            setupCanvasInteraction();

            // Â∑¶Âè≥ÂèçËª¢„ÉÅ„Çß„ÉÉ„ÇØ„Éú„ÉÉ„ÇØ„Çπ
            document.getElementById('flipHorizontal').addEventListener('change', (e) => {
                overlayState.flipHorizontal = e.target.checked;
                updateComposition();
            });

            // Ê∂à„Åó„Ç¥„É†„É¢„Éº„Éâ
            document.getElementById('eraserMode').addEventListener('change', (e) => {
                eraserState.isActive = e.target.checked;
                updateEraserUI();
                updateCanvasCursor();
            });

            // Ê∂à„Åó„Ç¥„É†„Çµ„Ç§„Ç∫
            const eraserSizeSlider = document.getElementById('eraserSizeSlider');
            const eraserSizeInput = document.getElementById('eraserSizeInput');
            
            eraserSizeSlider.addEventListener('input', (e) => {
                eraserState.size = parseInt(e.target.value);
                eraserSizeInput.value = eraserState.size;
            });
            
            eraserSizeInput.addEventListener('input', (e) => {
                eraserState.size = parseInt(e.target.value);
                eraserSizeSlider.value = eraserState.size;
            });

            // „ÉÄ„Ç¶„É≥„É≠„Éº„Éâ
            document.getElementById('downloadBtn').addEventListener('click', downloadImage);
        }

        // „Ç≥„É≥„Éà„É≠„Éº„É´Ë®≠ÂÆö
        function setupControls() {
            const controls = [
                { name: 'scale', property: 'scale', multiplier: 0.01 },
                { name: 'rotation', property: 'rotation', multiplier: 1 },
                { name: 'opacity', property: 'opacity', multiplier: 0.01 },
                { name: 'brightness', property: 'brightness', multiplier: 0.01 },
                { name: 'contrast', property: 'contrast', multiplier: 0.01 },
                { name: 'saturation', property: 'saturation', multiplier: 0.01 },
                { name: 'hue', property: 'hue', multiplier: 1 }
            ];

            controls.forEach(control => {
                const slider = document.getElementById(control.name + 'Slider');
                const input = document.getElementById(control.name + 'Input');
                
                slider.addEventListener('input', (e) => {
                    const value = parseInt(e.target.value);
                    input.value = value;
                    overlayState[control.property] = value * control.multiplier;
                    updateComposition();
                });
                
                input.addEventListener('input', (e) => {
                    const value = parseInt(e.target.value);
                    slider.value = value;
                    overlayState[control.property] = value * control.multiplier;
                    updateComposition();
                });
            });
        }

        // „Ç≠„É£„É≥„Éê„Çπ„Ç§„É≥„Çø„É©„ÇØ„Ç∑„Éß„É≥Ë®≠ÂÆö
        function setupCanvasInteraction() {
            // „Éû„Ç¶„Çπ„Ç§„Éô„É≥„Éà
            canvas.addEventListener('mousedown', handleMouseDown);
            canvas.addEventListener('mousemove', handleMouseMove);
            canvas.addEventListener('mouseup', handleMouseUp);
            canvas.addEventListener('wheel', handleWheel);
            canvas.addEventListener('mouseleave', handleMouseUp);

            // „Çø„ÉÉ„ÉÅ„Ç§„Éô„É≥„ÉàÔºà„Éö„É≥ÂØæÂøúÔºâ
            canvas.addEventListener('touchstart', handleTouchStart, { passive: false });
            canvas.addEventListener('touchmove', handleTouchMove, { passive: false });
            canvas.addEventListener('touchend', handleTouchEnd, { passive: false });
            canvas.addEventListener('touchcancel', handleTouchEnd, { passive: false });

            // „Éù„Ç§„É≥„Çø„Éº„Ç§„Éô„É≥„ÉàÔºà„Çà„ÇäÈ´òÁ≤æÂ∫¶„Å™„Éö„É≥Êìç‰ΩúÔºâ
            if (window.PointerEvent) {
                canvas.addEventListener('pointerdown', handlePointerDown);
                canvas.addEventListener('pointermove', handlePointerMove);
                canvas.addEventListener('pointerup', handlePointerUp);
                canvas.addEventListener('pointercancel', handlePointerUp);
            }
        }

        // Â∫ßÊ®ôÂèñÂæó„ÅÆÂÖ±ÈÄöÈñ¢Êï∞
        function getCanvasCoordinates(clientX, clientY) {
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            return {
                x: (clientX - rect.left) * scaleX,
                y: (clientY - rect.top) * scaleY
            };
        }

        // „Éû„Ç¶„Çπ„ÉÄ„Ç¶„É≥
        function handleMouseDown(e) {
            if (!backgroundImage || !overlayImage) return;
            e.preventDefault();

            const coords = getCanvasCoordinates(e.clientX, e.clientY);
            handleInteractionStart(coords.x, coords.y, e.shiftKey, 1.0);
        }

        // „Éû„Ç¶„ÇπÁßªÂãï
        function handleMouseMove(e) {
            if (!backgroundImage || !overlayImage) return;
            e.preventDefault();

            const coords = getCanvasCoordinates(e.clientX, e.clientY);
            handleInteractionMove(coords.x, coords.y, 1.0);
        }

        // „Éû„Ç¶„Çπ„Ç¢„ÉÉ„Éó
        function handleMouseUp(e) {
            if (e) e.preventDefault();
            handleInteractionEnd();
        }

        // „Éõ„Ç§„Éº„É´Âá¶ÁêÜÔºà„Çµ„Ç§„Ç∫Ë™øÊï¥Ôºâ
        function handleWheel(e) {
            if (!backgroundImage || !overlayImage || eraserState.isActive) return;
            
            e.preventDefault();
            
            const scaleDelta = e.deltaY > 0 ? -5 : 5;
            const newScale = Math.max(10, Math.min(300, Math.round((overlayState.scale * 100) + scaleDelta)));
            
            overlayState.scale = newScale / 100;
            
            // UIÊõ¥Êñ∞
            document.getElementById('scaleSlider').value = newScale;
            document.getElementById('scaleInput').value = newScale;
            
            updateComposition();
        }

        // ÈÄèÈÅéÁîªÂÉè„ÅÆÁØÑÂõ≤ÂÜÖ„Åã„ÉÅ„Çß„ÉÉ„ÇØ
        function isPointInOverlay(x, y) {
            const overlayWidth = overlayImage.width * overlayState.scale;
            const overlayHeight = overlayImage.height * overlayState.scale;
            
            const left = overlayState.x - overlayWidth / 2;
            const right = overlayState.x + overlayWidth / 2;
            const top = overlayState.y - overlayHeight / 2;
            const bottom = overlayState.y + overlayHeight / 2;
            
            return x >= left && x <= right && y >= top && y <= bottom;
        }

        // „Éâ„É©„ÉÉ„Ç∞&„Éâ„É≠„ÉÉ„ÉóË®≠ÂÆö
        function setupDragAndDrop() {
            const uploadBoxes = document.querySelectorAll('.upload-box');
            
            uploadBoxes.forEach(box => {
                box.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    box.classList.add('dragover');
                });
                
                box.addEventListener('dragleave', () => {
                    box.classList.remove('dragover');
                });
                
                box.addEventListener('drop', (e) => {
                    e.preventDefault();
                    box.classList.remove('dragover');
                    
                    const files = e.dataTransfer.files;
                    if (files.length > 0) {
                        const isBackground = box.querySelector('#backgroundInput');
                        if (isBackground) {
                            handleBackgroundFile(files[0]);
                        } else {
                            handleOverlayFile(files[0]);
                        }
                    }
                });
            });
        }

        // ËÉåÊôØÁîªÂÉèÂá¶ÁêÜ
        function handleBackgroundUpload(e) {
            const file = e.target.files[0];
            if (file) handleBackgroundFile(file);
        }

        function handleBackgroundFile(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.onload = () => {
                    backgroundImage = img;
                    updatePreview('background');
                    updateComposition();
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        // ÂêàÊàêÁîªÂÉèÂá¶ÁêÜ
        function handleOverlayUpload(e) {
            const file = e.target.files[0];
            if (file) handleOverlayFile(file);
        }

        function handleOverlayFile(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.onload = () => {
                    overlayImage = img;
                    updatePreview('overlay');
                    resetPosition();
                    initializeMask(); // „Éû„Çπ„ÇØ„Ç≠„É£„É≥„Éê„Çπ„ÇíÂàùÊúüÂåñ
                    updateComposition();
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        // „Éó„É¨„Éì„É•„ÉºÊõ¥Êñ∞
        function updatePreview(type) {
            if (type === 'background' && backgroundImage) {
                const preview = document.getElementById('backgroundPreview');
                const clearBtn = document.getElementById('clearBackground');
                
                preview.src = backgroundImage.src;
                preview.style.display = 'block';
                clearBtn.style.display = 'block';
            } else if (type === 'overlay' && overlayImage) {
                const preview = document.getElementById('overlayPreview');
                const clearBtn = document.getElementById('clearOverlay');
                
                preview.src = overlayImage.src;
                preview.style.display = 'block';
                clearBtn.style.display = 'block';
            }
        }

        // ÁîªÂÉè„ÇØ„É™„Ç¢
        function clearBackground() {
            backgroundImage = null;
            document.getElementById('backgroundPreview').style.display = 'none';
            document.getElementById('clearBackground').style.display = 'none';
            document.getElementById('backgroundInput').value = '';
            updateComposition();
        }

        function clearOverlay() {
            overlayImage = null;
            document.getElementById('overlayPreview').style.display = 'none';
            document.getElementById('clearOverlay').style.display = 'none';
            document.getElementById('overlayInput').value = '';
            
            // Ê∂à„Åó„Ç¥„É†Èñ¢ÈÄ£„ÅÆUI„Çí„É™„Çª„ÉÉ„Éà
            document.getElementById('eraserMode').checked = false;
            eraserState.isActive = false;
            updateEraserUI();
            
            updateComposition();
        }

        // ‰ΩçÁΩÆ„É™„Çª„ÉÉ„Éà
        function resetPosition() {
            if (backgroundImage) {
                overlayState.x = backgroundImage.width / 2;
                overlayState.y = backgroundImage.height / 2;
                overlayState.scale = 1;
                overlayState.rotation = 0;
                overlayState.flipHorizontal = false;
                
                // UIÊõ¥Êñ∞
                document.getElementById('scaleSlider').value = 100;
                document.getElementById('scaleInput').value = 100;
                document.getElementById('rotationSlider').value = 0;
                document.getElementById('rotationInput').value = 0;
                document.getElementById('flipHorizontal').checked = false;
                
                updateComposition();
            }
        }

        // Ëâ≤Ë™ø„É™„Çª„ÉÉ„Éà
        function resetColors() {
            overlayState.opacity = 1;
            overlayState.brightness = 1;
            overlayState.contrast = 1;
            overlayState.saturation = 1;
            overlayState.hue = 0;
            
            // UIÊõ¥Êñ∞
            document.getElementById('opacitySlider').value = 100;
            document.getElementById('opacityInput').value = 100;
            document.getElementById('brightnessSlider').value = 100;
            document.getElementById('brightnessInput').value = 100;
            document.getElementById('contrastSlider').value = 100;
            document.getElementById('contrastInput').value = 100;
            document.getElementById('saturationSlider').value = 100;
            document.getElementById('saturationInput').value = 100;
            document.getElementById('hueSlider').value = 0;
            document.getElementById('hueInput').value = 0;
            
            updateComposition();
        }

        // ÂêàÊàêÂá¶ÁêÜ
        function updateComposition() {
            if (!backgroundImage || !overlayImage) {
                canvas.style.display = 'none';
                document.getElementById('canvasPlaceholder').style.display = 'block';
                document.getElementById('downloadBtn').disabled = true;
                return;
            }

            // „Ç≠„É£„É≥„Éê„Çπ„Çµ„Ç§„Ç∫Ë®≠ÂÆö
            canvas.width = backgroundImage.width;
            canvas.height = backgroundImage.height;

            // ËÉåÊôØÊèèÁîª
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.drawImage(backgroundImage, 0, 0);

            // ÂêàÊàêÁîªÂÉè„ÅÆËâ≤Ë™øÊï¥„Å®„Éï„Ç£„É´„Çø„ÉºË®≠ÂÆö
            const filters = [
                `brightness(${overlayState.brightness})`,
                `contrast(${overlayState.contrast})`,
                `saturate(${overlayState.saturation})`,
                `hue-rotate(${overlayState.hue}deg)`
            ];
            ctx.filter = filters.join(' ');

            // ÂêàÊàêÁîªÂÉèÊèèÁîªÔºà„Éû„Çπ„ÇØ„ÇíÈÅ©Áî®Ôºâ
            ctx.save();
            ctx.globalAlpha = overlayState.opacity;
            ctx.translate(overlayState.x, overlayState.y);
            ctx.rotate(overlayState.rotation * Math.PI / 180);
            
            // Â∑¶Âè≥ÂèçËª¢„ÅÆÂá¶ÁêÜ
            if (overlayState.flipHorizontal) {
                ctx.scale(-1, 1);
            }
            
            const overlayWidth = overlayImage.width * overlayState.scale;
            const overlayHeight = overlayImage.height * overlayState.scale;
            
            // ‰∏ÄÊôÇ„Ç≠„É£„É≥„Éê„Çπ„ÅßÂêàÊàêÁîªÂÉè„Å®„Éû„Çπ„ÇØ„ÇíÂêàÊàê
            const tempCanvas = document.createElement('canvas');
            const tempCtx = tempCanvas.getContext('2d');
            tempCanvas.width = overlayWidth;
            tempCanvas.height = overlayHeight;
            
            // ÂêàÊàêÁîªÂÉè„ÇíÊèèÁîª
            tempCtx.drawImage(overlayImage, 0, 0, overlayWidth, overlayHeight);
            
            // „Éû„Çπ„ÇØ„ÇíÈÅ©Áî®ÔºàÊ∂àÂéªÈÉ®ÂàÜ„ÇíÈÄèÊòé„Å´„Åô„ÇãÔºâ
            if (maskCanvas) {
                tempCtx.globalCompositeOperation = 'destination-out';
                tempCtx.drawImage(maskCanvas, 0, 0, overlayWidth, overlayHeight);
            }
            
            // ÊúÄÁµÇÁµêÊûú„ÇíÊèèÁîª
            ctx.drawImage(tempCanvas, -overlayWidth / 2, -overlayHeight / 2);
            ctx.restore();

            // „Éï„Ç£„É´„Çø„Éº„Çí„É™„Çª„ÉÉ„Éà
            ctx.filter = 'none';

            // Ë°®Á§∫Êõ¥Êñ∞
            canvas.style.display = 'block';
            document.getElementById('canvasPlaceholder').style.display = 'none';
            document.getElementById('downloadBtn').disabled = false;
        }

        // „ÉÄ„Ç¶„É≥„É≠„Éº„Éâ
        function downloadImage() {
            if (!canvas) return;

            // ÁèæÂú®„ÅÆÊó•ÊôÇ„ÇíÂèñÂæó„Åó„Å¶„Éï„Ç©„Éº„Éû„ÉÉ„Éà
            const now = new Date();
            const year = now.getFullYear().toString().slice(-2); // Âπ¥„ÅÆ‰∏ã2Ê°Å
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const seconds = String(now.getSeconds()).padStart(2, '0');
            
            const timestamp = `_${year}${month}${day}_${hours}${minutes}${seconds}`;
            const filename = `composite_image${timestamp}.png`;

            canvas.toBlob((blob) => {
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }, 'image/png');
        }

        // „Çª„ÇØ„Ç∑„Éß„É≥Êäò„ÇäÁï≥„ÅøÊ©üËÉΩ
        function toggleSection(sectionId) {
            const section = document.getElementById(sectionId);
            section.classList.toggle('collapsed');
        }

        // „Éû„Çπ„ÇØ„Ç≠„É£„É≥„Éê„ÇπÂàùÊúüÂåñ
        function initializeMask() {
            if (!overlayImage) return;
            
            maskCanvas = document.createElement('canvas');
            maskCtx = maskCanvas.getContext('2d');
            maskCanvas.width = overlayImage.width;
            maskCanvas.height = overlayImage.height;
            
            // ÈÄèÊòé„ÅßÂàùÊúüÂåñ
            maskCtx.clearRect(0, 0, maskCanvas.width, maskCanvas.height);
        }

        // Ê∂à„Åó„Ç¥„É†UIÊõ¥Êñ∞
        function updateEraserUI() {
            const eraserSizeGroup = document.getElementById('eraserSizeGroup');
            const resetEraserBtn = document.getElementById('resetEraserBtn');
            
            if (eraserState.isActive) {
                eraserSizeGroup.style.display = 'block';
                resetEraserBtn.style.display = 'inline-block';
            } else {
                eraserSizeGroup.style.display = 'none';
                resetEraserBtn.style.display = 'none';
            }
        }

        // „Ç´„Éº„ÇΩ„É´Êõ¥Êñ∞
        function updateCanvasCursor() {
            if (eraserState.isActive) {
                canvas.classList.add('eraser-mode');
            } else {
                canvas.classList.remove('eraser-mode');
                canvas.style.cursor = overlayState.isDragging ? 'grabbing' : 'grab';
            }
        }

        // ÊåáÂÆöÁÇπ„ÅßÊ∂àÂéª
        function eraseAtPoint(x, y, pressure = 1.0) {
            if (!maskCanvas || !overlayImage) return;
            
            // ÂêàÊàêÁîªÂÉè„ÅÆÂ∫ßÊ®ôÁ≥ª„Å´Â§âÊèõ
            const localX = (x - overlayState.x) / overlayState.scale + overlayImage.width / 2;
            const localY = (y - overlayState.y) / overlayState.scale + overlayImage.height / 2;
            
            maskCtx.globalCompositeOperation = 'source-over';
            maskCtx.fillStyle = 'white';
            maskCtx.beginPath();
            // „Éö„É≥ÂúßÂäõ„Åß„Çµ„Ç§„Ç∫„ÇíË™øÊï¥
            maskCtx.arc(localX, localY, (eraserState.size * pressure) / overlayState.scale, 0, Math.PI * 2);
            maskCtx.fill();
            
            updateComposition();
        }

        // Á∑ö„ÅßÊ∂àÂéª
        function eraseLineTo(x, y, pressure = 1.0) {
            if (!maskCanvas || !overlayImage) return;
            
            const localX = (x - overlayState.x) / overlayState.scale + overlayImage.width / 2;
            const localY = (y - overlayState.y) / overlayState.scale + overlayImage.height / 2;
            const lastLocalX = (eraserState.lastX - overlayState.x) / overlayState.scale + overlayImage.width / 2;
            const lastLocalY = (eraserState.lastY - overlayState.y) / overlayState.scale + overlayImage.height / 2;
            
            maskCtx.globalCompositeOperation = 'source-over';
            maskCtx.strokeStyle = 'white';
            // „Éö„É≥ÂúßÂäõ„Åß„Çµ„Ç§„Ç∫„ÇíË™øÊï¥
            maskCtx.lineWidth = (eraserState.size * 2 * pressure) / overlayState.scale;
            maskCtx.lineCap = 'round';
            maskCtx.beginPath();
            maskCtx.moveTo(lastLocalX, lastLocalY);
            maskCtx.lineTo(localX, localY);
            maskCtx.stroke();
            
            updateComposition();
        }

        // Ê∂àÂéª„É™„Çª„ÉÉ„Éà
        function resetEraser() {
            if (maskCanvas) {
                maskCtx.clearRect(0, 0, maskCanvas.width, maskCanvas.height);
                updateComposition();
            }
        }

        // „Çø„ÉÉ„ÉÅ„Ç§„Éô„É≥„ÉàÂá¶ÁêÜ
        function handleTouchStart(e) {
            if (!backgroundImage || !overlayImage) return;
            e.preventDefault();
            
            if (e.touches.length === 1) {
                const touch = e.touches[0];
                const coords = getCanvasCoordinates(touch.clientX, touch.clientY);
                handleInteractionStart(coords.x, coords.y, false, 1.0);
            }
        }

        function handleTouchMove(e) {
            if (!backgroundImage || !overlayImage) return;
            e.preventDefault();
            
            if (e.touches.length === 1) {
                const touch = e.touches[0];
                const coords = getCanvasCoordinates(touch.clientX, touch.clientY);
                handleInteractionMove(coords.x, coords.y, 1.0);
            }
        }

        function handleTouchEnd(e) {
            e.preventDefault();
            handleInteractionEnd();
        }

        // „Éù„Ç§„É≥„Çø„Éº„Ç§„Éô„É≥„ÉàÂá¶ÁêÜÔºàÈ´òÁ≤æÂ∫¶„Éö„É≥ÂØæÂøúÔºâ
        function handlePointerDown(e) {
            if (!backgroundImage || !overlayImage) return;
            e.preventDefault();
            
            const coords = getCanvasCoordinates(e.clientX, e.clientY);
            const pressure = e.pressure || 1.0;
            handleInteractionStart(coords.x, coords.y, e.shiftKey, pressure);
        }

        function handlePointerMove(e) {
            if (!backgroundImage || !overlayImage) return;
            e.preventDefault();
            
            const coords = getCanvasCoordinates(e.clientX, e.clientY);
            const pressure = e.pressure || 1.0;
            handleInteractionMove(coords.x, coords.y, pressure);
        }

        function handlePointerUp(e) {
            e.preventDefault();
            handleInteractionEnd();
        }

        // ÂÖ±ÈÄö„ÅÆ„Ç§„É≥„Çø„É©„ÇØ„Ç∑„Éß„É≥Âá¶ÁêÜ
        function handleInteractionStart(x, y, isShiftKey, pressure) {
            eraserState.pressure = pressure;
            
            if (eraserState.isActive) {
                // Ê∂à„Åó„Ç¥„É†„É¢„Éº„Éâ
                eraserState.isErasing = true;
                eraserState.lastX = x;
                eraserState.lastY = y;
                eraseAtPoint(x, y, pressure);
            } else if (isPointInOverlay(x, y)) {
                // ÈÄöÂ∏∏„ÅÆÁßªÂãï„ÉªÂõûËª¢„É¢„Éº„Éâ
                overlayState.isDragging = true;
                overlayState.isRotating = isShiftKey;
                overlayState.dragStartX = x;
                overlayState.dragStartY = y;
                overlayState.initialX = overlayState.x;
                overlayState.initialY = overlayState.y;
                
                canvas.style.cursor = overlayState.isRotating ? 'grab' : 'grabbing';
            }
        }

        function handleInteractionMove(x, y, pressure) {
            eraserState.pressure = pressure;
            
            if (eraserState.isErasing) {
                // Ê∂à„Åó„Ç¥„É†„ÅßÁ∑ö„ÇíÊèè„Åè
                eraseLineTo(x, y, pressure);
                eraserState.lastX = x;
                eraserState.lastY = y;
                return;
            }

            if (!overlayState.isDragging) return;

            if (overlayState.isRotating) {
                // ÂõûËª¢Âá¶ÁêÜ
                const centerX = overlayState.x;
                const centerY = overlayState.y;
                const angle1 = Math.atan2(overlayState.dragStartY - centerY, overlayState.dragStartX - centerX);
                const angle2 = Math.atan2(y - centerY, x - centerX);
                const deltaAngle = (angle2 - angle1) * 180 / Math.PI;
                
                overlayState.rotation = (overlayState.rotation + deltaAngle) % 360;
                
                // UIÊõ¥Êñ∞
                document.getElementById('rotationSlider').value = Math.round(overlayState.rotation);
                document.getElementById('rotationInput').value = Math.round(overlayState.rotation);
                
                overlayState.dragStartX = x;
                overlayState.dragStartY = y;
            } else {
                // ÁßªÂãïÂá¶ÁêÜ
                overlayState.x = overlayState.initialX + (x - overlayState.dragStartX);
                overlayState.y = overlayState.initialY + (y - overlayState.dragStartY);
            }

            updateComposition();
        }

        function handleInteractionEnd() {
            overlayState.isDragging = false;
            overlayState.isRotating = false;
            eraserState.isErasing = false;
            updateCanvasCursor();
        }

        // ÂàùÊúüÂåñÂÆüË°å
        init();
    </script>
</body>
</html>